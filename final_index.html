<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pyramakerz â€” Operation System</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --or:#F97316;--ord:#EA580C;--orb:#FFF7ED;--orbd:#FED7AA;
  --g50:#F9FAFB;--g100:#F3F4F6;--g200:#E5E7EB;--g400:#9CA3AF;--g600:#4B5563;--g800:#1F2937;--g900:#111827;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI','Tahoma',sans-serif;background:var(--g50);color:var(--g900);direction:rtl;min-height:100vh;}

/* LOGIN */
#login-screen{position:fixed;inset:0;z-index:9999;background:linear-gradient(135deg,#fff7ed,#fff,#fff7ed);display:flex;align-items:center;justify-content:center;}
.lcard{background:#fff;border-radius:24px;padding:48px 44px 40px;width:380px;text-align:center;box-shadow:0 20px 60px rgba(249,115,22,.15);border:1px solid var(--orbd);}
.llogo{width:180px;margin:0 auto 20px;display:block;cursor:pointer;}
.ldiv{width:36px;height:3px;background:var(--or);border-radius:2px;margin:0 auto 18px;}
.ltitle{font-size:12px;font-weight:700;color:var(--g600);letter-spacing:2px;text-transform:uppercase;margin-bottom:24px;}
.linput{width:100%;padding:12px 16px;border:2px solid var(--g200);border-radius:10px;font-family:inherit;font-size:15px;text-align:center;letter-spacing:4px;outline:none;transition:border .2s;margin-bottom:12px;}
.linput:focus{border-color:var(--or);}
.lbtn{width:100%;padding:12px;background:var(--or);color:#fff;border:none;border-radius:10px;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;}
.lbtn:hover{background:var(--ord);}
.lerr{color:#ef4444;font-size:12px;margin-top:8px;display:none;}

/* APP */
#app{display:none;}

/* TOPBAR */
.topbar{background:#fff;border-bottom:2px solid var(--orbd);padding:0 32px;height:60px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 2px 10px rgba(249,115,22,.07);}
.tb-logo{display:flex;align-items:center;gap:12px;cursor:pointer;}
.tb-logo img{height:34px;}
.tb-sep{width:1px;height:26px;background:var(--orbd);}
.tb-title{font-size:13px;font-weight:700;color:var(--g800);letter-spacing:1px;}
.tb-right{display:flex;align-items:center;gap:8px;}
.tb-back{display:none;align-items:center;gap:5px;padding:6px 14px;background:var(--orb);border:1px solid var(--orbd);border-radius:8px;color:var(--ord);font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;}
.tb-back.show{display:flex;}
.tb-back:hover{background:var(--orbd);}
.sdot{width:7px;height:7px;border-radius:50%;background:#10b981;animation:pulse 2s infinite;display:inline-block;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.slbl{color:var(--g400);font-size:11px;}

/* BREADCRUMB - hidden, using topbar back btn only */
.bc{display:none!important;}

/* 3-DOT ACTION MENU */
.act-wrap{position:relative;display:inline-block;}
.act-btn{background:none;border:none;cursor:pointer;font-size:18px;color:var(--g400);padding:2px 6px;border-radius:5px;line-height:1;transition:all .15s;}
.act-btn:hover{background:var(--g100);color:var(--g800);}
.act-menu{display:none;position:absolute;left:0;top:100%;background:#fff;border:1px solid var(--g200);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.12);min-width:130px;z-index:200;overflow:hidden;}
.act-menu.open{display:block;}
.act-menu button{display:flex;align-items:center;gap:7px;width:100%;padding:9px 14px;border:none;background:none;font-family:inherit;font-size:12.5px;font-weight:600;cursor:pointer;text-align:right;color:var(--g800);transition:background .12s;}
.act-menu button:hover{background:var(--g100);}
.act-menu button.danger{color:#ef4444;}.act-menu button.danger:hover{background:#fef2f2;}
.act-menu button:not(:last-child){border-bottom:1px solid var(--g100);}

/* QTY COUNTER */
.qctr{display:inline-flex;align-items:center;gap:0;border:2px solid var(--g200);border-radius:8px;overflow:hidden;background:#fff;}
.qctr button{background:none;border:none;padding:4px 9px;font-size:15px;font-weight:700;color:var(--g600);cursor:pointer;transition:all .12s;line-height:1;}
.qctr button:hover{background:var(--orb);color:var(--or);}
.qctr span{min-width:32px;text-align:center;font-size:13px;font-weight:800;color:var(--g900);padding:4px 2px;}

/* LOADING */
.loader{position:fixed;inset:0;background:rgba(255,255,255,.88);z-index:500;display:none;align-items:center;justify-content:center;flex-direction:column;gap:14px;}
.loader.on{display:flex;}
.spin{width:38px;height:38px;border:4px solid var(--orbd);border-top-color:var(--or);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.spin-lbl{color:var(--g600);font-size:13px;font-weight:600;}

/* PAGES */
.page{display:none;padding:32px;}
.page.active{display:block;}

/* HOME */
.hero{background:linear-gradient(135deg,var(--or),var(--ord));border-radius:18px;padding:40px 44px;margin-bottom:32px;position:relative;overflow:hidden;color:#fff;}
.hero::before{content:'';position:absolute;top:-50px;right:-30px;width:220px;height:220px;background:rgba(255,255,255,.08);border-radius:50%;}
.hero::after{content:'';position:absolute;bottom:-70px;left:70px;width:270px;height:270px;background:rgba(0,0,0,.06);border-radius:50%;}
.hero-in{position:relative;z-index:2;}
.htag{font-size:10px;font-weight:700;letter-spacing:3px;text-transform:uppercase;opacity:.7;margin-bottom:8px;}
.htitle{font-size:36px;font-weight:800;line-height:1.1;}
.hsub{font-size:13px;opacity:.75;margin-top:8px;}
.cgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;}
.mcard{background:#fff;border-radius:18px;padding:32px 28px;cursor:pointer;border:2px solid var(--g200);transition:all .25s cubic-bezier(.34,1.56,.64,1);position:relative;overflow:hidden;}
.mcard:hover{border-color:var(--or);transform:translateY(-5px);box-shadow:0 18px 36px rgba(249,115,22,.14);}
.mcard:hover .carrow{background:var(--or);color:#fff;transform:rotate(-45deg);}
.mcard:hover .cicon{transform:scale(1.1);}
.cicon{width:56px;height:56px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:26px;margin-bottom:18px;transition:transform .2s;}
.io{background:linear-gradient(135deg,#FFF7ED,#FED7AA);}
.ib{background:linear-gradient(135deg,#EFF6FF,#BFDBFE);}
.ig{background:linear-gradient(135deg,#F0FDF4,#BBF7D0);}
.ip{background:linear-gradient(135deg,#FAF5FF,#E9D5FF);}
.cname{font-size:19px;font-weight:800;color:var(--g900);margin-bottom:7px;}
.cdesc{font-size:12px;color:var(--g400);line-height:1.6;}
.carrow{position:absolute;bottom:22px;left:22px;width:30px;height:30px;border-radius:50%;background:var(--orb);display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--or);transition:all .2s;}

/* PAGE HEADER */
.ph{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px;}
.ptitle{font-size:24px;font-weight:800;color:var(--g900);}

/* SECTION LABEL */
.slabel{font-size:11px;font-weight:700;color:var(--g400);letter-spacing:2px;text-transform:uppercase;display:flex;align-items:center;gap:7px;margin-bottom:14px;}
.slabel::before{content:'';width:4px;height:16px;background:var(--or);border-radius:2px;}

/* SCHOOLS */
.sgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;}
.scard{background:#fff;border-radius:14px;padding:24px 20px;cursor:pointer;border:2px solid var(--g200);transition:all .2s;position:relative;}
.scard:hover{border-color:var(--or);transform:translateY(-3px);box-shadow:0 10px 24px rgba(249,115,22,.12);}
.sicon{font-size:32px;margin-bottom:12px;}
.sname{font-size:15px;font-weight:800;color:var(--g900);margin-bottom:5px;}
.smeta{font-size:11px;color:var(--g400);}
.sdel{position:absolute;top:12px;left:12px;background:none;border:none;color:var(--g200);cursor:pointer;font-size:13px;padding:4px;border-radius:6px;transition:all .15s;}
.sdel:hover{background:#fef2f2;color:#ef4444;}

/* TABS */
.ttabs{display:flex;gap:6px;margin-bottom:20px;border-bottom:2px solid var(--g200);flex-wrap:wrap;}
.ttab{padding:9px 20px;background:none;border:none;border-radius:10px 10px 0 0;font-family:inherit;font-size:13px;font-weight:600;color:var(--g400);cursor:pointer;transition:all .15s;border-bottom:3px solid transparent;margin-bottom:-2px;}
.ttab.active{color:var(--or);border-bottom-color:var(--or);background:var(--orb);}
.ttab:hover:not(.active){color:var(--g800);background:var(--g100);}

/* TABLE */
.tcard{background:#fff;border-radius:12px;border:1px solid var(--g200);overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.04);margin-bottom:18px;}
table{width:100%;border-collapse:collapse;}
thead tr{background:linear-gradient(135deg,var(--ord),var(--or));}
thead th{padding:12px 14px;color:#fff;font-size:11px;font-weight:700;text-align:right;white-space:nowrap;}
thead th.tc{width:120px;}
thead th.tq{width:75px;text-align:center;}
thead th.ta{width:40px;text-align:center;}
tbody tr:nth-child(even){background:#fafafa;}
tbody tr:nth-child(odd){background:#fff;}
tbody tr:hover{background:#FFF7ED;}
tbody tr:last-child td{border-bottom:none;}
tbody tr.row-locked:hover{background:inherit;}
tbody td{padding:0;border-bottom:1px solid #f3f4f6;vertical-align:top;}
tbody td.tdc{vertical-align:middle;padding:9px 12px;}
tbody td.tdq{text-align:center;vertical-align:middle;padding:9px 6px;}
tbody td.tda{text-align:center;vertical-align:middle;padding:7px 4px;}
.cedit{width:100%;min-height:40px;padding:9px 13px;font-family:inherit;font-size:12.5px;color:var(--g800);background:transparent;border:none;outline:none;resize:none;line-height:1.6;display:block;}
.cedit:focus{background:rgba(249,115,22,.04);box-shadow:inset 3px 0 0 var(--or);}
.cedit:disabled{color:var(--g600);cursor:not-allowed;}
.row-locked .cedit{pointer-events:none;background:transparent!important;}
.qinput{width:56px;text-align:center;padding:5px;border:2px solid var(--g200);border-radius:7px;font-family:inherit;font-size:13px;font-weight:700;color:var(--g900);outline:none;background:#fff;transition:border .15s;}
.qinput:focus{border-color:var(--or);}
.qinput:disabled{background:#f3f4f6;color:var(--g600);cursor:not-allowed;border-color:#e5e7eb;}
.row-locked .qinput{pointer-events:none;}
select.csel{border:none;font-family:inherit;font-size:11px;font-weight:700;padding:3px 9px;border-radius:18px;cursor:pointer;outline:none;appearance:none;-webkit-appearance:none;}
select.csel:disabled{background:#f3f4f6;color:var(--g600);cursor:not-allowed;}
.cc{background:#EFF6FF;color:#2563EB;}.cm{background:#F0FDF4;color:#16A34A;}.ck{background:#FFF7ED;color:#EA580C;}.cmt{background:#FAF5FF;color:#9333EA;}
select.isel{width:100%;padding:9px 13px;border:none;background:transparent;font-family:inherit;font-size:12.5px;color:var(--g800);outline:none;cursor:pointer;appearance:none;-webkit-appearance:none;}
select.isel:focus{background:rgba(249,115,22,.04);}
select.isel:disabled{background:transparent;color:var(--g600);cursor:not-allowed;}
.row-locked select.isel{pointer-events:none;}
.bdel{background:none;border:none;color:var(--g200);cursor:pointer;font-size:13px;padding:4px 7px;border-radius:5px;transition:all .15s;}
.bdel:hover{background:#fef2f2;color:#ef4444;}
.addrow{width:100%;padding:10px;background:none;border:none;border-top:1px dashed var(--g200);color:var(--g400);font-family:inherit;font-size:12px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:5px;}
.addrow:hover{background:#FFF7ED;color:var(--or);}

/* BUTTONS */
.btn{padding:10px 20px;background:var(--or);color:#fff;border:none;border-radius:10px;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;transition:all .15s;}
.btn:hover{background:var(--ord);}
.btn.secondary{background:var(--g200);color:var(--g800);}
.btn.secondary:hover{background:var(--g300);}

/* MODALS */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:1000;align-items:center;justify-content:center;}
.modal.on{display:flex;}
.modal-content{background:#fff;border-radius:16px;padding:32px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.2);}
.modal-title{font-size:18px;font-weight:800;margin-bottom:16px;color:var(--g900);}
.modal-input{width:100%;padding:10px 14px;border:2px solid var(--g200);border-radius:10px;font-family:inherit;font-size:13px;margin-bottom:12px;outline:none;}
.modal-input:focus{border-color:var(--or);}
.modal-buttons{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;}
.modal-buttons button{padding:8px 16px;border:none;border-radius:8px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;transition:all .15s;}
.modal-buttons .btn-cancel{background:var(--g200);color:var(--g800);}
.modal-buttons .btn-cancel:hover{background:var(--g300);}
.modal-buttons .btn-confirm{background:var(--or);color:#fff;}
.modal-buttons .btn-confirm:hover{background:var(--ord);}

/* INV CHIPS / SCHOOL CHIPS */
.chip-grid{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
.chip{padding:8px 16px;background:var(--g200);color:var(--g800);border:none;border-radius:20px;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;}
.chip.active{background:var(--or);color:#fff;}
.chip:hover{background:var(--g300);}
.chip.active:hover{background:var(--ord);}

/* AUDIT FILTERS */
.audit-filters{background:#fff;border-radius:14px;padding:20px;border:1px solid var(--g200);margin-bottom:24px;display:flex;flex-direction:column;gap:16px;}
.filter-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.filter-label{font-size:12px;font-weight:700;color:var(--g600);min-width:80px;}
.filter-input{padding:8px 12px;border:2px solid var(--g200);border-radius:8px;font-family:inherit;font-size:13px;outline:none;}
.filter-input:focus{border-color:var(--or);}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="lcard">
    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 60'%3E%3Ctext x='50%' y='50%' font-size='32' font-weight='800' fill='%23F97316' text-anchor='middle' dominant-baseline='middle'%3EPyramakerz%3C/text%3E%3C/svg%3E" class="llogo">
    <div class="ldiv"></div>
    <div class="ltitle">Operation System</div>
    <input type="password" id="pw-input" class="linput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeypress="if(event.key==='Enter')tryLogin()">
    <button class="lbtn" onclick="tryLogin()">Ø¯Ø®ÙˆÙ„</button>
    <div class="lerr" id="lerr">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©</div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="tb-logo" onclick="goTo('home')">
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'%3E%3Ccircle cx='20' cy='20' r='18' fill='%23F97316' opacity='0.1'/%3E%3Ctext x='20' y='24' font-size='20' text-anchor='middle'%3EğŸ %3C/text%3E%3C/svg%3E">
      <div class="tb-sep"></div>
      <div class="tb-title">Pyramakerz</div>
    </div>
    <div class="tb-right">
      <div class="sdot"></div>
      <span class="slbl">Ù…ØªØµÙ„</span>
      <button class="tb-back" id="back-btn" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
    </div>
  </div>

  <!-- LOADER -->
  <div class="loader" id="loader">
    <div class="spin"></div>
    <div class="spin-lbl">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <!-- HOME PAGE -->
  <div id="page-home" class="page active">
    <div class="hero">
      <div class="hero-in">
        <div class="htag">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ</div>
        <div class="htitle">Pyramakerz Operation System</div>
        <div class="hsub">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø´Ø§Ù…Ù„ Ù„Ù„Ù…Ø¯Ø§Ø±Ø³ ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª</div>
      </div>
    </div>
    <div class="cgrid">
      <div class="mcard" onclick="goTo('schools')">
        <div class="cicon io">ğŸ«</div>
        <div class="cname">Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</div>
        <div class="cdesc">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ÙˆØ§Ù„Ø«ÙŠÙ…Ø§Øª ÙˆØ§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</div>
        <div class="carrow">â†’</div>
      </div>
      <div class="mcard" onclick="goTo('inventory')">
        <div class="cicon ib">ğŸ“¦</div>
        <div class="cname">Ø§Ù„Ø¥Ù†ÙÙ†ØªÙˆØ±ÙŠ</div>
        <div class="cdesc">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ø£ØµÙ†Ø§Ù ÙˆØ§Ù„Ø£Ø¶Ø±Ø§Ø±</div>
        <div class="carrow">â†’</div>
      </div>
      <div class="mcard" onclick="goTo('techday-home')">
        <div class="cicon ig">ğŸ”§</div>
        <div class="cname">Tech Day</div>
        <div class="cdesc">Ø®Ø·Ø· Ø§Ù„ØªØ­Ø¶ÙŠØ± ÙˆØ§Ù„Ø§Ø³ØªÙ„Ø§Ù…Ø§Øª ÙˆØ§Ù„ÙØ­ÙˆØµØ§Øª</div>
        <div class="carrow">â†’</div>
      </div>
      <div class="mcard" onclick="goTo('audit')">
        <div class="cicon ip">ğŸ“Š</div>
        <div class="cname">Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø³Ù†ÙˆÙŠ</div>
        <div class="cdesc">Ø¹Ø±Ø¶ Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
        <div class="carrow">â†’</div>
      </div>
    </div>
  </div>

  <!-- SCHOOLS PAGE -->
  <div id="page-schools" class="page">
    <div class="ph">
      <div class="ptitle">ğŸ« Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</div>
      <button class="btn" onclick="openModal('modal-school')">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø±Ø³Ø©</button>
    </div>
    <div class="sgrid" id="schools-grid"></div>
  </div>

  <!-- SCHOOL DETAIL PAGE -->
  <div id="page-school-detail" class="page">
    <div class="ph">
      <div class="ptitle" id="sd-title"></div>
      <button class="btn" onclick="addThemeRow()">+ Ø¥Ø¶Ø§ÙØ© ØµÙ</button>
    </div>
    <div class="ttabs" id="sd-tabs"></div>
    <div class="tcard">
      <table>
        <thead><tr>
          <th class="tc">Ø§Ù„ØµÙ†Ù</th>
          <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
          <th class="tq">Ø§Ù„Ø¹Ø¯Ø¯</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          <th class="ta">Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr></thead>
        <tbody id="theme-body"></tbody>
      </table>
      <button class="addrow" onclick="addThemeRow()">+ Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯</button>
    </div>
  </div>

  <!-- ANNUAL PAGE -->
  <div id="page-annual" class="page">
    <div class="ph">
      <div class="ptitle" id="an-title"></div>
      <button class="btn" onclick="openModal('modal-year')">+ Ø¥Ø¶Ø§ÙØ© Ø³Ù†Ø©</button>
    </div>
    <div id="yr-tabs" style="display:flex;gap:6px;margin-bottom:20px;border-bottom:2px solid var(--g200);flex-wrap:wrap;"></div>
    <div id="annual-tables"></div>
  </div>

  <!-- RETURNS PAGE -->
  <div id="page-returns" class="page">
    <div class="ph">
      <div class="ptitle" id="ret-title"></div>
      <button class="btn" onclick="addReturnRow()">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø±ØªØ¬Ø¹</button>
    </div>
    <div class="tcard">
      <table>
        <thead><tr>
          <th class="tc">Ø§Ù„ØµÙ†Ù</th>
          <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
          <th class="tq">Ø§Ù„Ø¹Ø¯Ø¯</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          <th class="ta">Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr></thead>
        <tbody id="returns-body"></tbody>
      </table>
      <button class="addrow" onclick="addReturnRow()">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø±ØªØ¬Ø¹ Ø¬Ø¯ÙŠØ¯</button>
    </div>
  </div>

  <!-- INVENTORY PAGE -->
  <div id="page-inventory" class="page">
    <div class="ph">
      <div class="ptitle">ğŸ“¦ Ø§Ù„Ø¥Ù†ÙÙ†ØªÙˆØ±ÙŠ</div>
      <button class="btn" onclick="addInvRow()">+ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
    </div>
    <div class="tcard">
      <table>
        <thead><tr>
          <th style="width:80px">ÙƒÙˆØ¯</th>
          <th class="tc">Ø§Ù„ØµÙ†Ù</th>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th class="tq">Ø§Ù„Ø¹Ø¯Ø¯</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          <th class="ta">Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr></thead>
        <tbody id="inv-body"></tbody>
      </table>
      <button class="addrow" onclick="addInvRow()">+ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</button>
    </div>
  </div>

  <!-- TECHDAY HOME PAGE -->
  <div id="page-techday-home" class="page">
    <div class="ph">
      <div class="ptitle">ğŸ”§ Tech Day</div>
    </div>
    <div class="cgrid">
      <div class="mcard" onclick="goTo('techday-prep')">
        <div class="cicon io">ğŸ“‹</div>
        <div class="cname">Ø®Ø·Ø© Ø§Ù„ØªØ­Ø¶ÙŠØ±</div>
        <div class="cdesc">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ù„Ø®Ø·ÙˆØ§Øª</div>
        <div class="carrow">â†’</div>
      </div>
      <div class="mcard" onclick="goTo('techday-recv')">
        <div class="cicon ib">ğŸ“¦</div>
        <div class="cname">Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…Ø§Øª</div>
        <div class="cdesc">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</div>
        <div class="carrow">â†’</div>
      </div>
      <div class="mcard" onclick="goTo('techday-check')">
        <div class="cicon ig">âœ…</div>
        <div class="cname">Check List</div>
        <div class="cdesc">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ­Øµ ÙˆØ§Ù„ØªØ³Ù„ÙŠÙ…</div>
        <div class="carrow">â†’</div>
      </div>
    </div>
  </div>

  <!-- TECHDAY PREP PAGE -->
  <div id="page-techday-prep" class="page">
    <div class="ph">
      <div class="ptitle">ğŸ“‹ Ø®Ø·Ø© Ø§Ù„ØªØ­Ø¶ÙŠØ±</div>
      <button class="btn" onclick="addTDRow('prep')">+ Ø¥Ø¶Ø§ÙØ© Ø®Ø·ÙˆØ©</button>
    </div>
    <div class="tcard">
      <table>
        <thead><tr>
          <th style="width:50px;text-align:center;">#</th>
          <th>Ø§Ù„Ù…Ù‡Ù…Ø©</th>
          <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
          <th class="ta">Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr></thead>
        <tbody id="tdprep-body"></tbody>
      </table>
      <button class="addrow" onclick="addTDRow('prep')">+ Ø¥Ø¶Ø§ÙØ© Ø®Ø·ÙˆØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>
  </div>

  <!-- TECHDAY RECV PAGE -->
  <div id="page-techday-recv" class="page">
    <div class="ph">
      <div class="ptitle">ğŸ“¦ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…Ø§Øª</div>
      <button class="btn" onclick="addTDRow('recv')">+ Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªÙ„Ø§Ù…</button>
    </div>
    <div class="tcard">
      <table>
        <thead><tr>
          <th class="tc">Ø§Ù„ØµÙ†Ù</th>
          <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
          <th class="tq">Ø§Ù„Ø¹Ø¯Ø¯</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th class="ta">Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr></thead>
        <tbody id="tdrecv-body"></tbody>
      </table>
      <button class="addrow" onclick="addTDRow('recv')">+ Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªÙ„Ø§Ù… Ø¬Ø¯ÙŠØ¯</button>
    </div>
  </div>

  <!-- TECHDAY CHECK PAGE -->
  <div id="page-techday-check" class="page">
    <div class="ph">
      <div class="ptitle">âœ… Check List</div>
      <button class="btn" onclick="addTDRow('check')">+ Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±</button>
    </div>
    <div class="tcard">
      <table>
        <thead><tr>
          <th style="width:50px;text-align:center;">âœ“</th>
          <th class="tc">Ø§Ù„ØµÙ†Ù</th>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th class="tq">Ø§Ù„Ø¹Ø¯Ø¯</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</th>
          <th class="ta">Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr></thead>
        <tbody id="tdcheck-body"></tbody>
      </table>
      <button class="addrow" onclick="addTDRow('check')">+ Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯</button>
    </div>
  </div>

  <!-- AUDIT PAGE -->
  <div id="page-audit" class="page">
    <div class="ph">
      <div class="ptitle">ğŸ“Š Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ø³Ù†ÙˆÙŠ</div>
    </div>
    
    <div class="audit-filters">
      <div class="filter-row">
        <div class="filter-label">Ø§Ù„Ø³Ù†Ø©:</div>
        <input type="text" id="audit-year" class="filter-input" placeholder="Ù…Ø«Ø§Ù„: 2025/2026" onchange="renderAudit()">
        <div class="filter-label" style="margin-right:20px">Ø§Ù„ØªØ§Ø±ÙŠØ®:</div>
        <input type="date" id="audit-date" class="filter-input" onchange="renderAudit()">
      </div>
      <div class="filter-row">
        <div class="filter-label">Ø§Ù„Ù…Ø¯Ø§Ø±Ø³:</div>
        <div id="audit-school-chips" class="chip-grid"></div>
      </div>
    </div>

    <div class="tcard">
      <table>
        <thead><tr>
          <th class="tc">Ø§Ù„ØµÙ†Ù</th>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th class="tq">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±Ø³Ù„Ø©</th>
          <th class="tq">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙØ¹Ù„ÙŠØ©</th>
          <th class="tq">Ø§Ù„ØªØ§Ù„ÙÙŠØ§Øª</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        </tr></thead>
        <tbody id="audit-body"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- MODALS -->
<div id="modal-school" class="modal">
  <div class="modal-content">
    <div class="modal-title">Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø±Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
    <input type="text" id="ms-name" class="modal-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©">
    <input type="text" id="ms-icon" class="modal-input" placeholder="Ø£ÙŠÙ‚ÙˆÙ†Ø© (emoji)">
    <div class="modal-buttons">
      <button class="btn-cancel" onclick="closeModal('modal-school')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-confirm" onclick="confirmAddSchool()">Ø¥Ø¶Ø§ÙØ©</button>
    </div>
  </div>
</div>

<div id="modal-year" class="modal">
  <div class="modal-content">
    <div class="modal-title">Ø¥Ø¶Ø§ÙØ© Ø³Ù†Ø© Ø¯Ø±Ø§Ø³ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</div>
    <input type="text" id="my-name" class="modal-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©">
    <div class="modal-buttons">
      <button class="btn-cancel" onclick="closeModal('modal-year')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn-confirm" onclick="confirmAddYear()">Ø¥Ø¶Ø§ÙØ©</button>
    </div>
  </div>
</div>

<script>
// ===== CONFIG =====
const SURL='https://xyzabc.supabase.co';
const SKEY='eyJhbGc...';
const {createClient}=supabase;
const db=createClient(SURL,SKEY);

// ===== AUTH =====
const PASS='pyramakerz';
function tryLogin(){
  if(document.getElementById('pw-input').value===PASS){
    document.getElementById('login-screen').style.display='none';
    document.getElementById('app').style.display='block';
    sessionStorage.setItem('pa','1');
    init();
  } else {
    document.getElementById('lerr').style.display='block';
    document.getElementById('pw-input').value='';
  }
}
if(sessionStorage.getItem('pa')==='1'){
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').style.display='block';
  document.addEventListener('DOMContentLoaded',init);
}

// ===== LOADER =====
const ld=()=>document.getElementById('loader').classList.add('on');
const uh=()=>document.getElementById('loader').classList.remove('on');

// ===== STATE =====
let schools=[],inventory=[],themeRows=[],returnRows=[],annualRows=[];
let tdPrep=[],tdRecv=[],tdCheck=[];
let curPage='home',curSchoolId=null,curTheme=0,curYear=null,curAnnualSchoolId=null,curReturnSchoolId=null;
let rowEditStates={};
let auditSelectedSchools=new Set();

// ===== MODAL =====
function openModal(id){document.getElementById(id).classList.add('on');}
function closeModal(id){document.getElementById(id).classList.remove('on');}

// ===== HISTORY & URL MANAGEMENT =====
function updateURL(){
  let path='';
  if(curPage==='home') path='/';
  else if(curPage==='schools') path='/schools';
  else if(curPage==='school-detail') path=`/school/${curSchoolId}?theme=${curTheme}`;
  else if(curPage==='annual') path=`/annual/${curAnnualSchoolId}?year=${curYear||''}`;
  else if(curPage==='returns') path=`/returns/${curReturnSchoolId}`;
  else if(curPage==='inventory') path='/inventory';
  else if(curPage==='techday-home') path='/techday';
  else if(curPage==='techday-prep') path='/techday/prep';
  else if(curPage==='techday-recv') path='/techday/recv';
  else if(curPage==='techday-check') path='/techday/check';
  else if(curPage==='audit') path='/audit';
  window.history.pushState({page:curPage,schoolId:curSchoolId,theme:curTheme,year:curYear,annualSchoolId:curAnnualSchoolId,returnSchoolId:curReturnSchoolId},curPage,path);
}

function parseURL(){
  const path=window.location.pathname;
  const params=new URLSearchParams(window.location.search);
  if(path==='/') goTo('home');
  else if(path==='/schools') goTo('schools');
  else if(path.startsWith('/school/')) {
    const id=path.split('/')[2];
    curTheme=parseInt(params.get('theme'))||0;
    goTo('school-detail',id);
  }
  else if(path.startsWith('/annual/')) {
    const id=path.split('/')[2];
    curYear=params.get('year')||null;
    goTo('annual',id);
  }
  else if(path.startsWith('/returns/')) {
    const id=path.split('/')[2];
    goTo('returns',id);
  }
  else if(path==='/inventory') goTo('inventory');
  else if(path==='/techday') goTo('techday-home');
  else if(path==='/techday/prep') goTo('techday-prep');
  else if(path==='/techday/recv') goTo('techday-recv');
  else if(path==='/techday/check') goTo('techday-check');
  else if(path==='/audit') goTo('audit');
  else goTo('home');
}

window.addEventListener('popstate',e=>{
  if(e.state){
    curPage=e.state.page;
    curSchoolId=e.state.schoolId;
    curTheme=e.state.theme;
    curYear=e.state.year;
    curAnnualSchoolId=e.state.annualSchoolId;
    curReturnSchoolId=e.state.returnSchoolId;
    parseURL();
  }
});

// ===== NAV =====
const pageParents={
  'schools':'home','school-detail':'schools','annual':'schools','returns':'schools',
  'inventory':'home','techday-home':'home',
  'techday-prep':'techday-home','techday-recv':'techday-home','techday-check':'techday-home',
  'audit':'home'
};

function goTo(page,extra){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const el=document.getElementById('page-'+page);
  if(el) el.classList.add('active');
  curPage=page;
  document.getElementById('back-btn').classList.toggle('show',page!=='home');
  updateURL();
  if(page==='schools'){loadSchools();}
  else if(page==='school-detail'){curSchoolId=extra;loadSchoolDetail();}
  else if(page==='annual'){curAnnualSchoolId=extra;loadAnnual();}
  else if(page==='returns'){curReturnSchoolId=extra;loadReturns();}
  else if(page==='inventory'){loadInventory();}
  else if(page==='techday-prep'){loadTD('prep');}
  else if(page==='techday-recv'){loadTD('recv');}
  else if(page==='techday-check'){loadTD('check');}
  else if(page==='audit'){loadAudit();}
}

function goBack(){
  const p=pageParents[curPage];
  if(p){
    if(p==='schools'&&(curPage==='school-detail'||curPage==='annual'||curPage==='returns')) goTo('schools');
    else goTo(p);
  } else goTo('home');
}

// ===== SCHOOLS =====
async function loadSchools(){
  ld();
  const {data}=await db.from('schools').select('*').order('created_at');
  schools=data||[];
  renderSchools();uh();
}

function renderSchools(){
  const g=document.getElementById('schools-grid');
  g.innerHTML='';
  schools.forEach(s=>{
    const d=document.createElement('div');
    d.className='scard';
    d.innerHTML=`
      <button class="sdel" onclick="event.stopPropagation();delSchool('${s.id}')">âœ•</button>
      <div class="sicon">${s.icon||'ğŸ«'}</div>
      <div class="sname">${s.name}</div>
      <div class="smeta">3 Ø«ÙŠÙ…Ø§Øª â€¢ Ø§Ø¶ØºØ· Ù„Ù„Ø¯Ø®ÙˆÙ„</div>`;
    d.onclick=()=>goTo('school-detail',s.id);
    g.appendChild(d);
  });
}

async function confirmAddSchool(){
  const name=document.getElementById('ms-name').value.trim();
  const icon=document.getElementById('ms-icon').value.trim()||'ğŸ«';
  if(!name) return;
  ld();closeModal('modal-school');
  const id='s'+Date.now();
  await db.from('schools').insert({id,name,icon});
  await loadSchools();uh();
}

async function delSchool(id){
  if(!confirm('ØªØ­Ø°Ù Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¯ÙŠ ÙˆÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§ØŸ'))return;
  ld();
  await db.from('school_themes').delete().eq('school_id',id);
  await db.from('school_returns').delete().eq('school_id',id);
  await db.from('schools').delete().eq('id',id);
  await loadSchools();uh();
}

// ===== SCHOOL DETAIL =====
async function loadSchoolDetail(){
  ld();
  const s=schools.find(x=>x.id===curSchoolId);
  if(!s){uh();return;}
  document.getElementById('sd-title').textContent=(s.icon||'ğŸ«')+' '+s.name;
  buildSchoolTabs(curSchoolId);
  await loadTheme();uh();
}

function buildSchoolTabs(schoolId){
  const tabs=document.getElementById('sd-tabs');
  tabs.innerHTML='';
  ['Theme One','Theme Two','Theme Three'].forEach((t,i)=>{
    const b=document.createElement('button');
    b.className='ttab'+(i===curTheme?' active':'');
    b.textContent=t;
    b.onclick=()=>{curTheme=i;updateURL();loadTheme();};
    tabs.appendChild(b);
  });
  const ba=document.createElement('button');
  ba.className='ttab';ba.textContent='ğŸ“… Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©';
  ba.style.cssText='background:#EFF6FF;color:#2563EB;border-color:#BFDBFE;';
  ba.onclick=()=>goTo('annual',schoolId);
  tabs.appendChild(ba);
  const br=document.createElement('button');
  br.className='ttab';br.textContent='â†©ï¸ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª';
  br.style.cssText='background:#FDF2F8;color:#9333EA;border-color:#E9D5FF;';
  br.onclick=()=>goTo('returns',schoolId);
  tabs.appendChild(br);
}

async function loadTheme(){
  ld();
  const {data}=await db.from('school_themes').select('*').eq('school_id',curSchoolId).eq('theme_index',curTheme).order('sort_order');
  themeRows=data||[];
  rowEditStates={};
  renderThemeTable();uh();
}

function renderThemeTable(){
  const tb=document.getElementById('theme-body');
  tb.innerHTML='';
  themeRows.forEach((row,i)=>{
    const invItems=inventory.filter(x=>x.cat===row.cat);
    const isCustom=row.item&&!invItems.find(x=>x.name===row.item);
    const catOpts=['components','machines','kits','materials'].map(c=>`<option value="${c}" ${c===row.cat?'selected':''}>${catLabel(c)}</option>`).join('');
    let itemOpts=`<option value="">-- Ø§Ø®ØªØ± --</option>`+
      invItems.map(x=>`<option value="${x.name}" ${x.name===row.item?'selected':''}>${x.name}</option>`).join('')+
      `<option value="__c__" ${isCustom?'selected':''}>âœï¸ ÙƒØªØ§Ø¨Ø© ÙŠØ¯ÙˆÙŠ</option>`;
    const isLocked=rowEditStates[row.id];
    const tr=document.createElement('tr');
    tr.id='row-'+row.id;
    tr.className=isLocked?'row-locked':'';
    tr.innerHTML=`
      <td class="tdc"><select class="csel c${catAbbr(row.cat)}" onchange="onThemeCat(${i},this)" ${isLocked?'disabled':''}>${catOpts}</select></td>
      <td>
        <select class="isel" onchange="onThemeItem(${i},this)" ${isLocked?'disabled':''}>${itemOpts}</select>
        <input type="text" class="cedit" style="display:${isCustom?'block':'none'};padding-top:0;min-height:28px"
          value="${isCustom?row.item:''}" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…..." onchange="updateTheme(${i},'item',this.value)" ${isLocked?'disabled':''} onkeypress="handleRowKeypress(event,'${row.id}')">
      </td>
      <td class="tdq">
        <div class="qctr">
          <button onclick="changeQty('theme',${i},-1)" ${isLocked?'disabled':''}>âˆ’</button>
          <span id="qty-theme-${i}">${row.qty||0}</span>
          <button onclick="changeQty('theme',${i},1)" ${isLocked?'disabled':''}>+</button>
        </div>
      </td>
      <td><textarea class="cedit" rows="1" oninput="ar(this)" onchange="updateTheme(${i},'note',this.value)" ${isLocked?'disabled':''} onkeypress="handleRowKeypress(event,'${row.id}')">${row.note||''}</textarea></td>
      <td class="tda">
        <div class="act-wrap">
          <button class="act-btn" onclick="toggleMenu(this)">â‹®</button>
          <div class="act-menu">
            <button onclick="unlockRow('${row.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="danger" onclick="delThemeRow('${row.id}',${i});closeAllMenus()">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </div>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('textarea').forEach(ar);
}

function onThemeCat(i,sel){sel.className=`csel c${catAbbr(sel.value)}`;updateTheme(i,'cat',sel.value);setTimeout(()=>renderThemeTable(),50);}
function onThemeItem(i,sel){
  const inp=sel.nextElementSibling;
  if(sel.value==='__c__'){inp.style.display='block';inp.focus();}
  else{inp.style.display='none';updateTheme(i,'item',sel.value);}
}
async function updateTheme(i,field,val){
  const r=themeRows[i];if(!r)return;r[field]=val;
  await db.from('school_themes').update({[field]:val}).eq('id',r.id);
}
async function addThemeRow(){
  ld();
  const id='st'+Date.now();
  await db.from('school_themes').insert({id,school_id:curSchoolId,theme_index:curTheme,cat:'components',item:'',qty:0,note:'',sort_order:themeRows.length});
  await loadTheme();uh();
}
async function delThemeRow(id,i){
  if(!confirm('ØªØ­Ø°Ù Ø§Ù„ØµÙØŸ'))return;ld();
  await db.from('school_themes').delete().eq('id',id);
  themeRows.splice(i,1);delete rowEditStates[id];renderThemeTable();uh();
}

// ===== ANNUAL =====
async function loadAnnual(){
  ld();
  const s=schools.find(x=>x.id===curAnnualSchoolId);
  document.getElementById('an-title').textContent=(s?.icon||'ğŸ«')+' '+(s?.name||'')+' â€” Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©';
  const {data:yrs}=await db.from('school_years').select('*').eq('school_id',curAnnualSchoolId).order('created_at');
  const years=yrs||[];
  renderYearTabs(years);
  if(years.length>0){
    if(!curYear) curYear=years[0].id;
    await loadAnnualRows();
  } else {
    curYear=null;
    document.getElementById('annual-tables').innerHTML='<div style="text-align:center;padding:40px;color:var(--g400)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù†ÙˆØ§Øª Ø¯Ø±Ø§Ø³ÙŠØ© â€” Ø£Ø¶Ù Ø³Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>';
  }
  uh();
}
function renderYearTabs(years){
  const t=document.getElementById('yr-tabs');
  t.innerHTML='';
  years.forEach(y=>{
    const b=document.createElement('button');
    b.className='yr-tab'+(y.id===curYear?' active':'');
    b.textContent=y.name;
    b.onclick=()=>{curYear=y.id;updateURL();loadAnnualRows();};
    t.appendChild(b);
  });
}
async function loadAnnualRows(){
  ld();
  const {data:themes}=await db.from('school_themes').select('*').eq('school_id',curAnnualSchoolId).order('theme_index').order('sort_order');
  annualRows=themes||[];
  renderAnnualTable();uh();
}
function renderAnnualTable(){
  const cont=document.getElementById('annual-tables');
  cont.innerHTML='';
  const tnames=['Theme One','Theme Two','Theme Three'];
  [0,1,2].forEach(t=>{
    const rows=annualRows.filter(r=>r.theme_index===t);
    if(!rows.length)return;
    const sec=document.createElement('div');
    sec.style.marginBottom='20px';
    let html=`<div style="font-size:14px;font-weight:800;color:var(--or);margin-bottom:10px;padding:8px 14px;background:var(--orb);border-radius:8px;border-right:4px solid var(--or)">${tnames[t]}</div>`;
    html+=`<div class="tcard"><table><thead><tr><th class="tc">Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th class="tq">Ø§Ù„Ø¹Ø¯Ø¯</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead><tbody>`;
    rows.forEach((r,i)=>{
      html+=`<tr style="background:${i%2?'#fafafa':'#fff'}">
        <td style="padding:9px 13px"><span style="padding:3px 9px;border-radius:14px;font-size:11px;font-weight:700;background:${catBg(r.cat)};color:${catClr(r.cat)}">${catLabel(r.cat)}</span></td>
        <td style="padding:9px 13px">${r.item||'-'}</td>
        <td style="padding:9px 13px;text-align:center;font-weight:700;color:var(--or)">${r.qty||0}</td>
        <td style="padding:9px 13px;color:var(--g600)">${r.note||'-'}</td>
      </tr>`;
    });
    html+=`</tbody></table></div>`;
    sec.innerHTML=html;cont.appendChild(sec);
  });
}
async function confirmAddYear(){
  const name=document.getElementById('my-name').value.trim();
  if(!name)return;ld();closeModal('modal-year');
  const id='y'+Date.now();
  await db.from('school_years').insert({id,school_id:curAnnualSchoolId,name});
  await loadAnnual();uh();
}

// ===== RETURNS =====
async function loadReturns(){
  ld();
  const s=schools.find(x=>x.id===curReturnSchoolId);
  document.getElementById('ret-title').textContent='â†©ï¸ Ù…Ø±ØªØ¬Ø¹Ø§Øª â€” '+(s?.name||'');
  const {data}=await db.from('school_returns').select('*').eq('school_id',curReturnSchoolId).order('created_at');
  returnRows=data||[];
  rowEditStates={};
  renderReturns();uh();
}
function renderReturns(){
  const tb=document.getElementById('returns-body');
  tb.innerHTML='';
  returnRows.forEach((row,i)=>{
    const invItems=inventory.filter(x=>x.cat===row.cat);
    const isCustom=row.item&&!invItems.find(x=>x.name===row.item);
    const catOpts=['components','machines','kits','materials'].map(c=>`<option value="${c}" ${c===row.cat?'selected':''}>${catLabel(c)}</option>`).join('');
    let itemOpts=`<option value="">-- Ø§Ø®ØªØ± --</option>`+
      invItems.map(x=>`<option value="${x.name}" ${x.name===row.item?'selected':''}>${x.name}</option>`).join('')+
      `<option value="__c__" ${isCustom?'selected':''}>âœï¸ ÙƒØªØ§Ø¨Ø© ÙŠØ¯ÙˆÙŠ</option>`;
    const isLocked=rowEditStates[row.id];
    const tr=document.createElement('tr');
    tr.id='row-'+row.id;
    tr.className=isLocked?'row-locked':'';
    tr.innerHTML=`
      <td class="tdc"><select class="csel c${catAbbr(row.cat)}" onchange="onRetCat(${i},this)" ${isLocked?'disabled':''}>${catOpts}</select></td>
      <td>
        <select class="isel" onchange="onRetItem(${i},this)" ${isLocked?'disabled':''}>${itemOpts}</select>
        <input type="text" class="cedit" style="display:${isCustom?'block':'none'};padding-top:0;min-height:28px"
          value="${isCustom?row.item:''}" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…..." onchange="updateRet(${i},'item',this.value)" ${isLocked?'disabled':''} onkeypress="handleRowKeypress(event,'${row.id}')">
      </td>
      <td class="tdq">
        <div class="qctr">
          <button onclick="changeQty('ret',${i},-1)" ${isLocked?'disabled':''}>âˆ’</button>
          <span id="qty-ret-${i}">${row.qty||0}</span>
          <button onclick="changeQty('ret',${i},1)" ${isLocked?'disabled':''}>+</button>
        </div>
      </td>
      <td><textarea class="cedit" rows="1" oninput="ar(this)" onchange="updateRet(${i},'note',this.value)" ${isLocked?'disabled':''} onkeypress="handleRowKeypress(event,'${row.id}')">${row.note||''}</textarea></td>
      <td class="tda">
        <div class="act-wrap">
          <button class="act-btn" onclick="toggleMenu(this)">â‹®</button>
          <div class="act-menu">
            <button onclick="unlockRow('${row.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="danger" onclick="delRetRow('${row.id}',${i});closeAllMenus()">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </div>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('textarea').forEach(ar);
}
function onRetCat(i,sel){sel.className=`csel c${catAbbr(sel.value)}`;updateRet(i,'cat',sel.value);setTimeout(()=>renderReturns(),50);}
function onRetItem(i,sel){
  const inp=sel.nextElementSibling;
  if(sel.value==='__c__'){inp.style.display='block';inp.focus();}
  else{inp.style.display='none';updateRet(i,'item',sel.value);}
}
async function updateRet(i,field,val){
  const r=returnRows[i];if(!r)return;r[field]=val;
  await db.from('school_returns').update({[field]:val}).eq('id',r.id);
}
async function addReturnRow(){
  ld();
  const id='sr'+Date.now();
  await db.from('school_returns').insert({id,school_id:curReturnSchoolId,cat:'components',item:'',qty:0,note:''});
  await loadReturns();uh();
}
async function delRetRow(id,i){
  if(!confirm('ØªØ­Ø°Ù Ø§Ù„ØµÙØŸ'))return;ld();
  await db.from('school_returns').delete().eq('id',id);
  returnRows.splice(i,1);delete rowEditStates[id];renderReturns();uh();
}

// ===== INVENTORY =====
async function loadInventory(){
  ld();
  const {data}=await db.from('inventory').select('*').order('cat').order('name');
  inventory=data||[];
  rowEditStates={};
  renderInventory();uh();
}
function renderInventory(){
  const tb=document.getElementById('inv-body');
  tb.innerHTML='';
  inventory.forEach((r,i)=>{
    const catOpts=['components','machines','kits','materials'].map(c=>`<option value="${c}" ${c===r.cat?'selected':''}>${catLabel(c)}</option>`).join('');
    const isLocked=rowEditStates[r.id];
    const tr=document.createElement('tr');
    tr.id='row-'+r.id;
    tr.className=isLocked?'row-locked':'';
    tr.innerHTML=`
      <td><input type="text" class="cedit" value="${r.id.substring(0,6)}" disabled></td>
      <td class="tdc"><select class="csel c${catAbbr(r.cat)}" onchange="updateInv('${r.id}','cat',this.value);this.className='csel c'+catAbbr(this.value)" ${isLocked?'disabled':''}>${catOpts}</select></td>
      <td><textarea class="cedit" rows="1" oninput="ar(this)" onchange="updateInv('${r.id}','name',this.value)" ${isLocked?'disabled':''} onkeypress="handleRowKeypress(event,'${r.id}')">${r.name||''}</textarea></td>
      <td class="tdq"><input type="number" class="qinput" value="${r.qty_sent||0}" onchange="updateInv('${r.id}','qty_sent',this.value)" ${isLocked?'disabled':''} onkeypress="handleRowKeypress(event,'${r.id}')"></td>
      <td><textarea class="cedit" rows="1" oninput="ar(this)" onchange="updateInv('${r.id}','notes',this.value)" ${isLocked?'disabled':''} onkeypress="handleRowKeypress(event,'${r.id}')">${r.notes||''}</textarea></td>
      <td class="tda">
        <div class="act-wrap">
          <button class="act-btn" onclick="toggleMenu(this)">â‹®</button>
          <div class="act-menu">
            <button onclick="unlockRow('${r.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="danger" onclick="delInvRow('${r.id}');closeAllMenus()">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </div>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('textarea').forEach(ar);
}
async function updateInv(id,field,val){
  const r=inventory.find(x=>x.id===id);if(r)r[field]=val;
  await db.from('inventory').update({[field]:val}).eq('id',id);
}
async function addInvRow(){
  ld();
  const id='i'+Date.now();
  await db.from('inventory').insert({id,cat:'components',name:'ØµÙ†Ù Ø¬Ø¯ÙŠØ¯',notes:'',qty_sent:0,qty_actual:0});
  await loadInventory();uh();
}
async function delInvRow(id){
  if(!confirm('ØªØ­Ø°Ù Ø§Ù„ØµÙ†ÙØŸ'))return;ld();
  await db.from('inventory').delete().eq('id',id);
  inventory=inventory.filter(x=>x.id!==id);
  delete rowEditStates[id];
  renderInventory();uh();
}

// ===== TECH DAY =====
const tdTables={prep:'tdprep-body',recv:'tdrecv-body',check:'tdcheck-body'};
async function loadTD(type){
  ld();
  const {data}=await db.from('techday_'+type).select('*').order('sort_order');
  if(type==='prep') tdPrep=data||[];
  else if(type==='recv') tdRecv=data||[];
  else tdCheck=data||[];
  rowEditStates={};
  renderTD(type);uh();
}
function renderTD(type){
  const tb=document.getElementById(tdTables[type]);
  tb.innerHTML='';
  const rows=type==='prep'?tdPrep:type==='recv'?tdRecv:tdCheck;
  rows.forEach((row,i)=>{
    const isLocked=rowEditStates[row.id];
    const tr=document.createElement('tr');
    tr.id='row-'+row.id;
    tr.className=isLocked?'row-locked':'';
    if(type==='prep'){
      tr.innerHTML=`<td style="text-align:center;vertical-align:middle;padding:9px 5px"><span style="display:inline-flex;width:26px;height:26px;border-radius:7px;align-items:center;justify-content:center;font-size:11px;font-weight:800;background:#f3f4f6;color:var(--g600)">${i+1}</span></td>
        <td><textarea class="cedit" style="font-weight:700" rows="1" oninput="ar(this)" onchange="updateTD('prep','${row.id}','name',this.value)" ${isLocked?'disabled':''} onkeypress="handleRowKeypress(event,'${row.id}')">${row.name||''}</textarea></td>
        <td><textarea class="cedit" style="color:var(--g600);font-size:12px" rows="1" oninput="ar(this)" onchange="updateTD('prep','${row.id}','detail',this.value)" ${isLocked?'disabled':''} onkeypress="handleRowKeypress(event,'${row.id}')">${row.detail||''}</textarea></td>
        <td class="tda"><div class="act-wrap"><button class="act-btn" onclick="toggleMenu(this)">â‹®</button><div class="act-menu"><button onclick="unlockRow('${row.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button><button class="danger" onclick="delTD('prep','${row.id}',${i});closeAllMenus()">ğŸ—‘ï¸ Ø­Ø°Ù</button></div></div></td>`;
    } else if(type==='recv'){
      const catOpts=['components','machines','kits','materials'].map(c=>`<option value="${c}" ${c===row.cat?'selected':''}>${catLabel(c)}</option>`).join('');
      const statOpts=['Ù„Ù… ÙŠÙØ³ØªÙ„Ù…','Ù…ÙƒØªÙ…Ù„','Ù†Ø§Ù‚Øµ','ØªØ§Ù„Ù'].map(s=>`<option ${s===row.status?'selected':''}>${s}</option>`).join('');
      tr.innerHTML=`<td class="tdc"><select class="csel c${catAbbr(row.cat||'components')}" onchange="updateTD('recv','${row.id}','cat',this.value);this.className='csel c'+catAbbr(this.value)" ${isLocked?'disabled':''}>${catOpts}</select></td>
        <td><textarea class="cedit" rows="1" oninput="ar(this)" onchange="updateTD('recv','${row.id}','item',this.value)" ${isLocked?'disabled':''} onkeypress="handleRowKeypress(event,'${row.id}')">${row.item||''}</textarea></td>
        <td class="tdq"><div class="qctr"><button onclick="changeQty('tdrecv',${i},-1)" ${isLocked?'disabled':''}>âˆ’</button><span id="qty-tdrecv-${i}">${row.qty||0}</span><button onclick="changeQty('tdrecv',${i},1)" ${isLocked?'disabled':''}>+</button></div></td>
        <td><select class="isel" onchange="updateTD('recv','${row.id}','status',this.value)" ${isLocked?'disabled':''}>${statOpts}</select></td>
        <td class="tda"><div class="act-wrap"><button class="act-btn" onclick="toggleMenu(this)">â‹®</button><div class="act-menu"><button onclick="unlockRow('${row.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button><button class="danger" onclick="delTD('recv','${row.id}',${i});closeAllMenus()">ğŸ—‘ï¸ Ø­Ø°Ù</button></div></div></td>`;
    } else {
      const catOpts=['components','machines','kits','materials'].map(c=>`<option value="${c}" ${c===row.cat?'selected':''}>${catLabel(c)}</option>`).join('');
      tr.innerHTML=`<td style="text-align:center;vertical-align:middle;padding:9px 5px"><input type="checkbox" ${row.done?'checked':''} onchange="updateTD('check','${row.id}','done',this.checked)"></td>
        <td class="tdc"><select class="csel c${catAbbr(row.cat||'components')}" onchange="updateTD('check','${row.id}','cat',this.value);this.className='csel c'+catAbbr(this.value)" ${isLocked?'disabled':''}>${catOpts}</select></td>
        <td><textarea class="cedit" rows="1" oninput="ar(this)" onchange="updateTD('check','${row.id}','name',this.value)" ${isLocked?'disabled':''} onkeypress="handleRowKeypress(event,'${row.id}')">${row.name||''}</textarea></td>
        <td class="tdq"><div class="qctr"><button onclick="changeQtyCheck(${i},-1)" ${isLocked?'disabled':''}>âˆ’</button><span id="qty-chk-${i}">${row.qty||0}</span><button onclick="changeQtyCheck(${i},1)" ${isLocked?'disabled':''}>+</button></div></td>
        <td><textarea class="cedit" rows="1" oninput="ar(this)" onchange="updateTD('check','${row.id}','note',this.value)" ${isLocked?'disabled':''} onkeypress="handleRowKeypress(event,'${row.id}')">${row.note||''}</textarea></td>
        <td><input type="date" class="cedit" value="${row.delivery_date||''}" onchange="updateTD('check','${row.id}','delivery_date',this.value)" ${isLocked?'disabled':''}></td>
        <td class="tda"><div class="act-wrap"><button class="act-btn" onclick="toggleMenu(this)">â‹®</button><div class="act-menu"><button onclick="unlockRow('${row.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button><button class="danger" onclick="delTD('check','${row.id}',${i});closeAllMenus()">ğŸ—‘ï¸ Ø­Ø°Ù</button></div></div></td>`;
    }
    tb.appendChild(tr);
  });
  tb.querySelectorAll('textarea').forEach(ar);
}
async function updateTD(type,id,field,val){await db.from('techday_'+type).update({[field]:val}).eq('id',id);}
async function addTDRow(type){
  ld();const id='td'+Date.now();
  const base={id,sort_order:(type==='prep'?tdPrep:type==='recv'?tdRecv:tdCheck).length};
  if(type==='prep') await db.from('techday_prep').insert({...base,name:'Ø®Ø·ÙˆØ© Ø¬Ø¯ÙŠØ¯Ø©'});
  else if(type==='recv') await db.from('techday_recv').insert({...base,cat:'components',item:'',qty:0,status:'Ù„Ù… ÙŠÙØ³ØªÙ„Ù…'});
  else await db.from('techday_check').insert({...base,cat:'components',name:'',note:'',done:false,qty:0});
  await loadTD(type);uh();
}
async function delTD(type,id,i){if(!confirm('ØªØ­Ø°ÙØŸ'))return;ld();await db.from('techday_'+type).delete().eq('id',id);await loadTD(type);uh();}

// ===== AUDIT =====
async function loadAudit(){
  ld();
  const {data:sc}=await db.from('schools').select('*').order('created_at');
  schools=sc||[];
  renderAuditSchoolChips();
  renderAudit();uh();
}
function renderAuditSchoolChips(){
  const cont=document.getElementById('audit-school-chips');
  cont.innerHTML='';
  schools.forEach(s=>{
    const c=document.createElement('button');
    c.className='chip'+(auditSelectedSchools.has(s.id)?' active':'');
    c.textContent=(s.icon||'ğŸ«')+' '+s.name;
    c.onclick=()=>{if(auditSelectedSchools.has(s.id))auditSelectedSchools.delete(s.id);else auditSelectedSchools.add(s.id);renderAuditSchoolChips();renderAudit();};
    cont.appendChild(c);
  });
}
async function renderAudit(){
  const tb=document.getElementById('audit-body');
  tb.innerHTML='';
  let query=db.from('inventory').select('*');
  if(auditSelectedSchools.size>0) query=query.in('school_id',Array.from(auditSelectedSchools));
  const {data}=await query.order('cat').order('name');
  const rows=data||[];
  if(!rows.length){tb.innerHTML='<tr><td colspan="6" style="text-align:center;padding:28px;color:var(--g400)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø±Ø¯ Ù…Ø·Ø§Ø¨Ù‚Ø©</td></tr>';return;}
  rows.forEach((r,i)=>{
    const dmg=Math.max(0,(parseInt(r.qty_sent)||0)-(parseInt(r.qty_actual)||0));
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="tdc"><span style="padding:3px 9px;border-radius:14px;font-size:11px;font-weight:700;background:${catBg(r.cat)};color:${catClr(r.cat)}">${catLabel(r.cat)}</span></td>
      <td style="padding:9px 13px">${r.name||'-'}</td>
      <td class="tdq" style="font-weight:700">${r.qty_sent||0}</td>
      <td class="tdq"><input type="number" class="qinput" value="${r.qty_actual||0}" onchange="updateInv('${r.id}','qty_actual',this.value);renderAudit()"></td>
      <td class="tdq" style="color:${dmg>0?'#ef4444':'#10b981'};font-weight:700">${dmg}</td>
      <td><textarea class="cedit" rows="1" oninput="ar(this)" onchange="updateInv('${r.id}','notes',this.value)">${r.notes||''}</textarea></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('textarea').forEach(ar);
}

// ===== ROW LOCKING SYSTEM =====
function lockRow(rowId){
  rowEditStates[rowId]=true;
  const row=document.getElementById('row-'+rowId);
  if(row){
    row.classList.add('row-locked');
    row.querySelectorAll('input, select, textarea').forEach(el=>{if(el.type!=='checkbox') el.disabled=true;});
  }
}
function unlockRow(rowId){
  delete rowEditStates[rowId];
  const row=document.getElementById('row-'+rowId);
  if(row){
    row.classList.remove('row-locked');
    row.querySelectorAll('input, select, textarea').forEach(el=>{el.disabled=false;});
    const input=row.querySelector('select.isel')||row.querySelector('textarea');
    if(input) input.focus();
  }
}
function handleRowKeypress(event,rowId){if(event.key==='Enter'){event.preventDefault();lockRow(rowId);}}

// ===== UTILS =====
function catLabel(c){return {components:'Components',machines:'Machines',kits:'Kits',materials:'Materials'}[c]||c;}
function catAbbr(c){return {components:'c',machines:'m',kits:'k',materials:'mt'}[c]||'c';}
function catBg(c){return {components:'#EFF6FF',machines:'#F0FDF4',kits:'#FFF7ED',materials:'#FAF5FF'}[c]||'#f3f4f6';}
function catClr(c){return {components:'#2563EB',machines:'#16A34A',kits:'#EA580C',materials:'#9333EA'}[c]||'#374151';}
function ar(el){el.style.height='auto';el.style.height=el.scrollHeight+'px';}
function toggleMenu(btn){const menu=btn.nextElementSibling;const isOpen=menu.classList.contains('open');closeAllMenus();if(!isOpen) menu.classList.add('open');}
function closeAllMenus(){document.querySelectorAll('.act-menu.open').forEach(m=>m.classList.remove('open'));}
document.addEventListener('click',e=>{if(!e.target.closest('.act-wrap'))closeAllMenus();});

async function changeQty(type,i,delta){
  let row,tbl;
  if(type==='theme'){row=themeRows[i];tbl='school_themes';}
  else if(type==='ret'){row=returnRows[i];tbl='school_returns';}
  else if(type==='tdrecv'){row=tdRecv[i];tbl='techday_recv';}
  if(!row)return;
  const newQty=Math.max(0,(parseInt(row.qty)||0)+delta);
  row.qty=newQty;
  const span=document.getElementById(`qty-${type}-${i}`);
  if(span)span.textContent=newQty;
  await db.from(tbl).update({qty:newQty}).eq('id',row.id);
}
async function changeQtyCheck(i,delta){
  const row=tdCheck[i];if(!row)return;
  const newQty=Math.max(0,(parseInt(row.qty)||0)+delta);
  row.qty=newQty;
  const span=document.getElementById(`qty-chk-${i}`);
  if(span)span.textContent=newQty;
  await db.from('techday_check').update({qty:newQty}).eq('id',row.id);
}

// ===== INIT =====
async function init(){
  ld();
  const {data:inv}=await db.from('inventory').select('*').order('cat').order('name');
  inventory=inv||[];
  const {data:sc}=await db.from('schools').select('*').order('created_at');
  schools=sc||[];
  uh();
  parseURL();
}
</script>
</body>
</html>
