<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pyramakerz â€” Operation System</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --or:#F97316;--ord:#EA580C;--orb:#FFF7ED;--orbd:#FED7AA;
  --g50:#F9FAFB;--g100:#F3F4F6;--g200:#E5E7EB;--g400:#9CA3AF;--g600:#4B5563;--g800:#1F2937;--g900:#111827;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI','Tahoma',sans-serif;background:var(--g50);color:var(--g900);direction:rtl;min-height:100vh;}

/* LOGIN */
#login-screen{position:fixed;inset:0;z-index:9999;background:linear-gradient(135deg,#fff7ed,#fff,#fff7ed);display:flex;align-items:center;justify-content:center;}
.lcard{background:#fff;border-radius:24px;padding:48px 44px 40px;width:380px;text-align:center;box-shadow:0 20px 60px rgba(249,115,22,.15);border:1px solid var(--orbd);}
.llogo{width:180px;margin:0 auto 20px;display:block;cursor:pointer;}
.ldiv{width:36px;height:3px;background:var(--or);border-radius:2px;margin:0 auto 18px;}
.ltitle{font-size:12px;font-weight:700;color:var(--g600);letter-spacing:2px;text-transform:uppercase;margin-bottom:24px;}
.linput{width:100%;padding:12px 16px;border:2px solid var(--g200);border-radius:10px;font-family:inherit;font-size:15px;text-align:center;letter-spacing:4px;outline:none;transition:border .2s;margin-bottom:12px;}
.linput:focus{border-color:var(--or);}
.lbtn{width:100%;padding:12px;background:var(--or);color:#fff;border:none;border-radius:10px;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;}
.lbtn:hover{background:var(--ord);}
.lerr{color:#ef4444;font-size:12px;margin-top:8px;display:none;}

/* APP */
#app{display:none;}

/* TOPBAR */
.topbar{background:#fff;border-bottom:2px solid var(--orbd);padding:0 32px;height:60px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 2px 10px rgba(249,115,22,.07);}
.tb-logo{display:flex;align-items:center;gap:12px;cursor:pointer;}
.tb-logo img{height:34px;}
.tb-sep{width:1px;height:26px;background:var(--orbd);}
.tb-title{font-size:13px;font-weight:700;color:var(--g800);letter-spacing:1px;}
.tb-right{display:flex;align-items:center;gap:8px;}
.tb-back{display:none;align-items:center;gap:5px;padding:6px 14px;background:var(--orb);border:1px solid var(--orbd);border-radius:8px;color:var(--ord);font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;}
.tb-back.show{display:flex;}
.tb-back:hover{background:var(--orbd);}
.sdot{width:7px;height:7px;border-radius:50%;background:#10b981;animation:pulse 2s infinite;display:inline-block;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.slbl{color:var(--g400);font-size:11px;}

/* BREADCRUMB - hidden, using topbar back btn only */
.bc{display:none!important;}

/* QTY COUNTER */
.qctr{display:inline-flex;align-items:center;gap:0;border:2px solid var(--g200);border-radius:8px;overflow:hidden;background:#fff;}
.qctr button{background:none;border:none;padding:4px 9px;font-size:15px;font-weight:700;color:var(--g600);cursor:pointer;transition:all .12s;line-height:1;}
.qctr button:hover{background:var(--orb);color:var(--or);}
.qctr span{min-width:32px;text-align:center;font-size:13px;font-weight:800;color:var(--g900);padding:4px 2px;}

/* LOADING */
.loader{position:fixed;inset:0;background:rgba(255,255,255,.88);z-index:500;display:none;align-items:center;justify-content:center;flex-direction:column;gap:14px;}
.loader.on{display:flex;}
.spin{width:38px;height:38px;border:4px solid var(--orbd);border-top-color:var(--or);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.spin-lbl{color:var(--g600);font-size:13px;font-weight:600;}

/* PAGES */
.page{display:none;padding:32px;}
.page.active{display:block;}

/* HOME */
.hero{background:linear-gradient(135deg,var(--or),var(--ord));border-radius:18px;padding:40px 44px;margin-bottom:32px;position:relative;overflow:hidden;color:#fff;}
.hero::before{content:'';position:absolute;top:-50px;right:-30px;width:220px;height:220px;background:rgba(255,255,255,.08);border-radius:50%;}
.hero::after{content:'';position:absolute;bottom:-70px;left:70px;width:270px;height:270px;background:rgba(0,0,0,.06);border-radius:50%;}
.hero-in{position:relative;z-index:2;}
.htag{font-size:10px;font-weight:700;letter-spacing:3px;text-transform:uppercase;opacity:.7;margin-bottom:8px;}
.htitle{font-size:36px;font-weight:800;line-height:1.1;}
.hsub{font-size:13px;opacity:.75;margin-top:8px;}
.cgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;}
.mcard{background:#fff;border-radius:18px;padding:32px 28px;cursor:pointer;border:2px solid var(--g200);transition:all .25s cubic-bezier(.34,1.56,.64,1);position:relative;overflow:hidden;}
.mcard:hover{border-color:var(--or);transform:translateY(-5px);box-shadow:0 18px 36px rgba(249,115,22,.14);}
.mcard:hover .carrow{background:var(--or);color:#fff;transform:rotate(-45deg);}
.mcard:hover .cicon{transform:scale(1.1);}
.cicon{width:56px;height:56px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:26px;margin-bottom:18px;transition:transform .2s;}
.io{background:linear-gradient(135deg,#FFF7ED,#FED7AA);}
.ib{background:linear-gradient(135deg,#EFF6FF,#BFDBFE);}
.ig{background:linear-gradient(135deg,#F0FDF4,#BBF7D0);}
.ip{background:linear-gradient(135deg,#FAF5FF,#E9D5FF);}
.cname{font-size:19px;font-weight:800;color:var(--g900);margin-bottom:7px;}
.cdesc{font-size:12px;color:var(--g400);line-height:1.6;}
.carrow{position:absolute;bottom:22px;left:22px;width:30px;height:30px;border-radius:50%;background:var(--orb);display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--or);transition:all .2s;}

/* PAGE HEADER */
.ph{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px;}
.ptitle{font-size:24px;font-weight:800;color:var(--g900);}

/* SECTION LABEL */
.slabel{font-size:11px;font-weight:700;color:var(--g400);letter-spacing:2px;text-transform:uppercase;display:flex;align-items:center;gap:7px;margin-bottom:14px;}
.slabel::before{content:'';width:4px;height:16px;background:var(--or);border-radius:2px;}

/* SCHOOLS */
.sgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;}
.scard{background:#fff;border-radius:14px;padding:24px 20px;cursor:pointer;border:2px solid var(--g200);transition:all .2s;position:relative;}
.scard:hover{border-color:var(--or);transform:translateY(-3px);box-shadow:0 10px 24px rgba(249,115,22,.12);}
.sicon{font-size:32px;margin-bottom:12px;}
.sname{font-size:15px;font-weight:800;color:var(--g900);margin-bottom:5px;}
.smeta{font-size:11px;color:var(--g400);}
.sdel{position:absolute;top:12px;left:12px;background:none;border:none;color:var(--g200);cursor:pointer;font-size:13px;padding:4px;border-radius:6px;transition:all .15s;}
.sdel:hover{background:#fef2f2;color:#ef4444;}

/* TABS */
.ttabs{display:flex;gap:6px;margin-bottom:20px;border-bottom:2px solid var(--g200);flex-wrap:wrap;}
.ttab{padding:9px 20px;background:none;border:none;border-radius:10px 10px 0 0;font-family:inherit;font-size:13px;font-weight:600;color:var(--g400);cursor:pointer;transition:all .15s;border-bottom:3px solid transparent;margin-bottom:-2px;}
.ttab.active{color:var(--or);border-bottom-color:var(--or);background:var(--orb);}
.ttab:hover:not(.active){color:var(--g800);background:var(--g100);}

/* TABLE */
.tcard{background:#fff;border-radius:12px;border:1px solid var(--g200);overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.04);margin-bottom:18px;}
table{width:100%;border-collapse:collapse;}
thead tr{background:linear-gradient(135deg,var(--ord),var(--or));}
thead th{padding:12px 14px;color:#fff;font-size:11px;font-weight:700;text-align:right;white-space:nowrap;}
thead th.tc{width:120px;}
thead th.tq{width:75px;text-align:center;}
tbody tr:nth-child(even){background:#fafafa;}
tbody tr:nth-child(odd){background:#fff;}
tbody tr:hover{background:#FFF7ED;}
tbody tr:last-child td{border-bottom:none;}
tbody td{padding:0;border-bottom:1px solid #f3f4f6;vertical-align:top;}
tbody td.tdc{vertical-align:middle;padding:9px 12px;}
tbody td.tdq{text-align:center;vertical-align:middle;padding:9px 6px;}
.cedit{width:100%;min-height:40px;padding:9px 13px;font-family:inherit;font-size:12.5px;color:var(--g800);background:transparent;border:none;outline:none;resize:none;line-height:1.6;display:block;}
.cedit:focus{background:rgba(249,115,22,.04);box-shadow:inset 3px 0 0 var(--or);}
.qinput{width:56px;text-align:center;padding:5px;border:2px solid var(--g200);border-radius:7px;font-family:inherit;font-size:13px;font-weight:700;color:var(--g900);outline:none;background:#fff;transition:border .15s;}
.qinput:focus{border-color:var(--or);}
select.csel{border:none;font-family:inherit;font-size:11px;font-weight:700;padding:3px 9px;border-radius:18px;cursor:pointer;outline:none;appearance:none;-webkit-appearance:none;}
.cc{background:#EFF6FF;color:#2563EB;}.cm{background:#F0FDF4;color:#16A34A;}.ck{background:#FFF7ED;color:#EA580C;}.cmt{background:#FAF5FF;color:#9333EA;}
select.isel{width:100%;padding:9px 13px;border:none;background:transparent;font-family:inherit;font-size:12.5px;color:var(--g800);outline:none;cursor:pointer;appearance:none;-webkit-appearance:none;}
select.isel:focus{background:rgba(249,115,22,.04);}

/* MODAL */
.modal{position:fixed;inset:0;background:rgba(17,24,39,.4);backdrop-filter:blur(4px);z-index:1000;display:none;align-items:center;justify-content:center;padding:20px;}
.modal.open{display:flex;}
.mcontent{background:#fff;border-radius:20px;width:100%;max-width:440px;box-shadow:0 25px 50px -12px rgba(0,0,0,.25);overflow:hidden;animation:mshow .3s ease-out;}
@keyframes mshow{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.mhead{padding:24px 28px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--g100);}
.mtitle{font-size:18px;font-weight:800;color:var(--g900);}
.mclose{background:none;border:none;color:var(--g400);cursor:pointer;font-size:20px;padding:4px;transition:color .15s;}
.mclose:hover{color:var(--g900);}
.mbody{padding:28px;}
.mfoot{padding:18px 28px 24px;display:flex;justify-content:flex-end;gap:12px;background:var(--g50);}
.mbtn{padding:10px 20px;border-radius:10px;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;transition:all .15s;}
.mbtn-p{background:var(--or);color:#fff;border:none;}
.mbtn-p:hover{background:var(--ord);}
.mbtn-s{background:#fff;color:var(--g600);border:1.5px solid var(--g200);}
.mbtn-s:hover{background:var(--g100);color:var(--g900);}

/* FORM */
.fgroup{margin-bottom:20px;}
.flabel{display:block;font-size:13px;font-weight:700;color:var(--g600);margin-bottom:8px;}
.finput{width:100%;padding:12px 16px;border:2px solid var(--g200);border-radius:10px;font-family:inherit;font-size:14px;outline:none;transition:border .2s;}
.finput:focus{border-color:var(--or);}

/* TOAST */
.toast-msg{position:fixed;bottom:32px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--g900);color:#fff;padding:12px 24px;border-radius:12px;font-size:13px;font-weight:600;z-index:10000;transition:transform .3s cubic-bezier(.34,1.56,.64,1);box-shadow:0 10px 25px rgba(0,0,0,.2);}
.toast-msg.show{transform:translateX(-50%) translateY(0);}

/* DELIVERY BADGE */
.dbadge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:var(--orb);border:1px solid var(--orbd);border-radius:8px;font-size:12px;font-weight:700;color:var(--ord);}

/* UTILS */
.df{display:flex;align-items:center;gap:10px;}
.dg{display:grid;gap:16px;}
.mt2{margin-top:8px;}
.mt4{margin-top:16px;}
.mb4{margin-bottom:16px;}
</style>
</head>
<body>

<div id="login-screen">
  <div class="lcard">
    <img src="https://pyramakerz.com/wp-content/uploads/2023/10/Pyramakerz-Logo.png" class="llogo" onclick="location.reload()">
    <div class="ldiv"></div>
    <div class="ltitle">Operation System</div>
    <input type="password" id="pass-input" class="linput" placeholder="â€¢â€¢â€¢â€¢" maxlength="4" autofocus>
    <button onclick="checkLogin()" class="lbtn">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    <div id="login-err" class="lerr">Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­</div>
  </div>
</div>

<div id="app">
  <div class="topbar">
    <div class="tb-logo" onclick="goHome()">
      <img src="https://pyramakerz.com/wp-content/uploads/2023/10/Pyramakerz-Logo.png">
      <div class="tb-sep"></div>
      <div class="tb-title">Operation System</div>
    </div>
    <div class="tb-right">
      <button id="back-btn" class="tb-back" onclick="history.back()"><span>â†</span> Ø¹ÙˆØ¯Ø©</button>
      <div class="df" style="margin-right:12px">
        <div class="sdot"></div>
        <div class="slbl">Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…</div>
      </div>
    </div>
  </div>

  <!-- HOME -->
  <div id="page-home" class="page">
    <div class="hero">
      <div class="hero-in">
        <div class="htag">Welcome Back</div>
        <div class="htitle">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
        <div class="hsub">ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ØŒ Ø§Ù„Ù…Ø®Ø§Ø²Ù†ØŒ ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø¨ÙƒÙ„ Ø³Ù‡ÙˆÙ„Ø©</div>
      </div>
    </div>
    <div class="cgrid">
      <div class="mcard" onclick="navTo('schools')">
        <div class="cicon io">ğŸ«</div>
        <div class="cname">Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</div>
        <div class="cdesc">Ø¥Ø¯Ø§Ø±Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ØŒ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©ØŒ ÙˆØ§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</div>
        <div class="carrow">â†’</div>
      </div>
      <div class="mcard" onclick="navTo('inventory')">
        <div class="cicon ib">ğŸ“¦</div>
        <div class="cname">Ø§Ù„Ù…Ø®Ø§Ø²Ù†</div>
        <div class="cdesc">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…ØªÙˆÙØ±Ø©ØŒ Ø§Ù„ÙƒÙ…ÙŠØ§ØªØŒ ÙˆØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ù…ÙˆØ§Ø¯</div>
        <div class="carrow">â†’</div>
      </div>
      <div class="mcard" onclick="navTo('techday')">
        <div class="cicon ig">ğŸ› ï¸</div>
        <div class="cname">Tech Day</div>
        <div class="cdesc">ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ©ØŒ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ù‡Ø¯ØŒ ÙˆÙ‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
        <div class="carrow">â†’</div>
      </div>
      <div class="mcard" onclick="navTo('audit')">
        <div class="cicon ip">ğŸ“Š</div>
        <div class="cname">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
        <div class="cdesc">Ø¹Ø±Ø¶ Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ÙˆØ§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</div>
        <div class="carrow">â†’</div>
      </div>
    </div>
  </div>

  <!-- SCHOOLS LIST -->
  <div id="page-schools" class="page">
    <div class="ph">
      <div class="ptitle">Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</div>
      <button class="mbtn mbtn-p" onclick="openModal('modal-school')">+ Ù…Ø¯Ø±Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>
    <div class="slabel">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</div>
    <div id="schools-grid" class="sgrid"></div>
  </div>

  <!-- SCHOOL DETAIL -->
  <div id="page-school-detail" class="page">
    <div class="ph">
      <div class="df">
        <div id="sd-icon" style="font-size:32px">ğŸ«</div>
        <div>
          <div id="sd-name" class="ptitle">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
          <div id="sd-delivery" class="mt2"></div>
        </div>
      </div>
      <div class="df">
        <button class="mbtn mbtn-s" onclick="openModal('modal-delivery')">ğŸ“… Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
        <button class="mbtn mbtn-p" onclick="navTo('annual')">ğŸ“š Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</button>
        <button class="mbtn mbtn-s" style="border-color:#ef4444;color:#ef4444" onclick="navTo('returns')">â†©ï¸ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</button>
      </div>
    </div>

    <div class="ttabs">
      <button class="ttab active" onclick="setTheme(0,this)">Theme One</button>
      <button class="ttab" onclick="setTheme(1,this)">Theme Two</button>
      <button class="ttab" onclick="setTheme(2,this)">Theme Three</button>
    </div>

    <div class="tcard">
      <table>
        <thead>
          <tr>
            <th class="tc">Ø§Ù„ØªØµÙ†ÙŠÙ</th>
            <th>Ø§Ù„ØµÙ†Ù / Ø§Ù„Ù…Ø§Ø¯Ø©</th>
            <th class="tq">Ø§Ù„Ø¹Ø¯Ø¯</th>
            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="theme-body"></tbody>
      </table>
    </div>
    <button class="mbtn mbtn-p" onclick="addThemeRow()">+ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
  </div>

  <!-- ANNUAL VIEW -->
  <div id="page-annual" class="page">
    <div class="ph">
      <div id="an-title" class="ptitle">Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</div>
      <div class="df">
        <div id="an-theme-filters" class="df" style="background:#fff;padding:6px 14px;border-radius:10px;border:1px solid var(--g200);font-size:12px;font-weight:700">
          <label class="df" style="cursor:pointer"><input type="checkbox" checked onchange="renderAnnualTable()"> T1</label>
          <label class="df" style="cursor:pointer"><input type="checkbox" checked onchange="renderAnnualTable()"> T2</label>
          <label class="df" style="cursor:pointer"><input type="checkbox" checked onchange="renderAnnualTable()"> T3</label>
        </div>
        <button class="mbtn mbtn-p" onclick="openModal('modal-year')">+ Ø³Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      </div>
    </div>
    <div id="yr-tabs" class="ttabs"></div>
    <div id="annual-tables"></div>
  </div>

  <!-- RETURNS -->
  <div id="page-returns" class="page">
    <div class="ph">
      <div id="ret-title" class="ptitle">Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</div>
    </div>
    <div class="tcard">
      <table>
        <thead>
          <tr>
            <th class="tc">Ø§Ù„ØªØµÙ†ÙŠÙ</th>
            <th>Ø§Ù„ØµÙ†Ù</th>
            <th class="tq">Ø§Ù„Ø¹Ø¯Ø¯</th>
            <th>Ø§Ù„Ø³Ø¨Ø¨ / Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="returns-body"></tbody>
      </table>
    </div>
    <button class="mbtn mbtn-p" onclick="addReturnRow()">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø±ØªØ¬Ø¹</button>
  </div>

  <!-- INVENTORY -->
  <div id="page-inventory" class="page">
    <div class="ph">
      <div class="ptitle">Ø§Ù„Ù…Ø®Ø§Ø²Ù†</div>
      <button class="mbtn mbtn-p" onclick="addInvRow()">+ ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</button>
    </div>
    
    <div class="dg" style="grid-template-columns:repeat(4,1fr);margin-bottom:24px">
      <div style="background:#fff;padding:16px;border-radius:14px;border:1px solid var(--g200);text-align:center">
        <div style="font-size:11px;font-weight:700;color:var(--g400);text-transform:uppercase;margin-bottom:4px">Components</div>
        <div id="st-components" style="font-size:24px;font-weight:800;color:#2563EB">0</div>
      </div>
      <div style="background:#fff;padding:16px;border-radius:14px;border:1px solid var(--g200);text-align:center">
        <div style="font-size:11px;font-weight:700;color:var(--g400);text-transform:uppercase;margin-bottom:4px">Machines</div>
        <div id="st-machines" style="font-size:24px;font-weight:800;color:#16A34A">0</div>
      </div>
      <div style="background:#fff;padding:16px;border-radius:14px;border:1px solid var(--g200);text-align:center">
        <div style="font-size:11px;font-weight:700;color:var(--g400);text-transform:uppercase;margin-bottom:4px">Kits</div>
        <div id="st-kits" style="font-size:24px;font-weight:800;color:#EA580C">0</div>
      </div>
      <div style="background:#fff;padding:16px;border-radius:14px;border:1px solid var(--g200);text-align:center">
        <div style="font-size:11px;font-weight:700;color:var(--g400);text-transform:uppercase;margin-bottom:4px">Materials</div>
        <div id="st-materials" style="font-size:24px;font-weight:800;color:#9333EA">0</div>
      </div>
    </div>

    <div class="tcard">
      <table>
        <thead>
          <tr>
            <th class="tc">Ø§Ù„ØªØµÙ†ÙŠÙ</th>
            <th>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
            <th class="tq">Ø§Ù„Ù…Ø³Ø­ÙˆØ¨</th>
            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="inv-body"></tbody>
      </table>
    </div>
  </div>

  <!-- TECH DAY -->
  <div id="page-techday" class="page">
    <div class="ph">
      <div class="ptitle">Tech Day Preparation</div>
    </div>

    <div class="slabel">1. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø£Ø¯ÙˆØ§Øª (Preparation List)</div>
    <div class="tcard">
      <table>
        <thead><tr><th style="width:40px">#</th><th>Ø§Ù„Ø£Ø¯Ø§Ø© / Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th><th>Ù…ÙƒÙˆÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</th></tr></thead>
        <tbody id="tdprep-body"></tbody>
      </table>
    </div>
    <button class="mbtn mbtn-p mb4" onclick="addTD('prep')">+ Ø¥Ø¶Ø§ÙØ© Ø£Ø¯Ø§Ø©</button>

    <div class="slabel">2. Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ù‡Ø¯Ø© (Receiving)</div>
    <div class="tcard">
      <table>
        <thead><tr><th class="tc">Ø§Ù„ØªØµÙ†ÙŠÙ</th><th>Ø§Ù„ØµÙ†Ù</th><th class="tq">Ø§Ù„Ø¹Ø¯Ø¯</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
        <tbody id="tdrecv-body"></tbody>
      </table>
    </div>
    <button class="mbtn mbtn-p mb4" onclick="addTD('recv')">+ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø§Ø³ØªÙ„Ø§Ù…</button>

    <div class="slabel">3. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Final Checklist)</div>
    <div class="tcard">
      <table>
        <thead><tr><th style="width:40px"></th><th>Ø§Ù„Ù…Ù‡Ù…Ø©</th></tr></thead>
        <tbody id="tdcheck-body"></tbody>
      </table>
    </div>
    <button class="mbtn mbtn-p" onclick="addTD('check')">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©</button>
  </div>

  <!-- AUDIT -->
  <div id="page-audit" class="page">
    <div class="ph">
      <div class="ptitle">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</div>
      <button class="mbtn mbtn-s" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
    </div>
    <div id="audit-content"></div>
  </div>

</div>

<!-- MODALS -->
<div id="modal-school" class="modal">
  <div class="mcontent">
    <div class="mhead"><div class="mtitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø±Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©</div><button class="mclose" onclick="closeModal('modal-school')">Ã—</button></div>
    <div class="mbody">
      <div class="fgroup"><label class="flabel">Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (Emoji)</label><input type="text" id="ms-icon" class="finput" placeholder="ğŸ«" value="ğŸ«"></div>
      <div class="fgroup"><label class="flabel">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</label><input type="text" id="ms-name" class="finput" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù†ÙŠÙ„ Ø§Ù„Ø¯ÙˆÙ„ÙŠØ©"></div>
    </div>
    <div class="mfoot"><button class="mbtn mbtn-s" onclick="closeModal('modal-school')">Ø¥Ù„ØºØ§Ø¡</button><button class="mbtn mbtn-p" onclick="confirmAddSchool()">Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</button></div>
  </div>
</div>

<div id="modal-year" class="modal">
  <div class="mcontent">
    <div class="mhead"><div class="mtitle">Ø¥Ø¶Ø§ÙØ© Ø³Ù†Ø© Ø¯Ø±Ø§Ø³ÙŠØ©</div><button class="mclose" onclick="closeModal('modal-year')">Ã—</button></div>
    <div class="mbody">
      <div class="fgroup"><label class="flabel">Ø§Ø³Ù… Ø§Ù„Ø³Ù†Ø© (Ù…Ø«Ù„Ø§Ù‹: 2024/2025)</label><input type="text" id="my-name" class="finput" placeholder="2024/2025"></div>
    </div>
    <div class="mfoot"><button class="mbtn mbtn-s" onclick="closeModal('modal-year')">Ø¥Ù„ØºØ§Ø¡</button><button class="mbtn mbtn-p" onclick="confirmAddYear()">Ø¥Ø¶Ø§ÙØ©</button></div>
  </div>
</div>

<div id="modal-delivery" class="modal">
  <div class="mcontent">
    <div class="mhead"><div class="mtitle">ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…</div><button class="mclose" onclick="closeModal('modal-delivery')">Ã—</button></div>
    <div class="mbody">
      <div class="dg" style="grid-template-columns:repeat(3,1fr)">
        <div class="fgroup"><label class="flabel">Ø§Ù„ÙŠÙˆÙ…</label><input type="number" id="del-day" class="finput" placeholder="DD" min="1" max="31"></div>
        <div class="fgroup"><label class="flabel">Ø§Ù„Ø´Ù‡Ø±</label><input type="number" id="del-month" class="finput" placeholder="MM" min="1" max="12"></div>
        <div class="fgroup"><label class="flabel">Ø§Ù„Ø³Ù†Ø©</label><input type="number" id="del-year" class="finput" placeholder="YYYY" value="2025"></div>
      </div>
    </div>
    <div class="mfoot">
      <button class="mbtn mbtn-s" style="margin-left:auto;color:#ef4444" onclick="clearDeliveryDate();closeModal('modal-delivery')">Ù…Ø³Ø­ Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
      <button class="mbtn mbtn-s" onclick="closeModal('modal-delivery')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="mbtn mbtn-p" onclick="saveDeliveryDate();closeModal('modal-delivery')">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆØ¹Ø¯</button>
    </div>
  </div>
</div>

<div id="loader" class="loader"><div class="spin"></div><div class="spin-lbl">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>

<script>
const SUPABASE_URL = 'https://pndvpxvquvuvqvxvpvpv.supabase.co'; // Placeholder
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // Placeholder
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let schools=[], inventory=[], themeRows=[], returnRows=[], tdPrep=[], tdRecv=[], tdCheck=[];
let curSchoolId=null, curTheme=0, curAnnualSchoolId=null, curYear=null, curReturnSchoolId=null;

// ===== AUTH & NAV =====
function checkLogin(){
  const p=document.getElementById('pass-input').value;
  if(p==='2025'){
    document.getElementById('login-screen').style.display='none';
    document.getElementById('app').style.display='block';
    init();
  }else{
    const err=document.getElementById('login-err');
    err.style.display='block';
    setTimeout(()=>err.style.display='none',2000);
  }
}
document.getElementById('pass-input').addEventListener('keypress',e=>{if(e.key==='Enter')checkLogin();});

function navTo(pageId, schoolId=null){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+pageId).classList.add('active');
  document.getElementById('back-btn').classList.toggle('show', pageId!=='home');
  
  if(pageId==='schools') loadSchools();
  if(pageId==='school-detail' && schoolId){ curSchoolId=schoolId; curTheme=0; loadSchoolDetail(); }
  if(pageId==='annual' && schoolId){ curAnnualSchoolId=schoolId; curYear=null; loadAnnual(); }
  if(pageId==='returns' && schoolId){ curReturnSchoolId=schoolId; loadReturns(); }
  if(pageId==='inventory') loadInventory();
  if(pageId==='techday'){ loadTD('prep'); loadTD('recv'); loadTD('check'); }
  if(pageId==='audit') loadAudit();

  if(pageId!=='home') history.pushState({page:pageId, schoolId}, '', '#'+pageId);
}
window.onpopstate=e=>{
  const s=e.state;
  if(!s || s.page==='home'){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById('page-home').classList.add('active');
    document.getElementById('back-btn').classList.remove('show');
  } else {
    navTo(s.page, s.schoolId);
  }
};
function goHome(){ history.pushState({page:'home'},'','#home'); navTo('home'); }

// ===== UI UTILS =====
function ld(){document.getElementById('loader').classList.add('on');}
function uh(){document.getElementById('loader').classList.remove('on');}
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}

// ===== SCHOOLS =====
async function loadSchools(){
  ld();
  const {data}=await db.from('schools').select('*').order('created_at');
  schools=data||[];
  renderSchools();uh();
}
function renderSchools(){
  const grid=document.getElementById('schools-grid');
  grid.innerHTML='';
  schools.forEach(s=>{
    const card=document.createElement('div');
    card.className='scard';
    card.onclick=()=>navTo('school-detail', s.id);
    card.innerHTML=`
      <button class="sdel" onclick="event.stopPropagation();delSchool('${s.id}')">ğŸ—‘ï¸</button>
      <div class="sicon">${s.icon||'ğŸ«'}</div>
      <div class="sname">${s.name}</div>
      <div class="smeta" id="badge-${s.id}"></div>
    `;
    grid.appendChild(card);
    updateDeliveryBadge(s);
  });
}
function updateDeliveryBadge(s){
  const b=document.getElementById('badge-'+s.id);
  const sd=document.getElementById('sd-delivery');
  let txt='';
  if(s.delivery_day){
    txt=`ğŸ“… ØªØ³Ù„ÙŠÙ…: ${s.delivery_day}/${s.delivery_month}/${s.delivery_year}`;
  }
  if(b) b.innerHTML=txt?`<span class="dbadge">${txt}</span>`:'';
  if(sd && curSchoolId===s.id) sd.innerHTML=txt?`<span class="dbadge" style="font-size:14px;padding:6px 12px">${txt}</span>`:'';
}
async function confirmAddSchool(){
  const name=document.getElementById('ms-name').value.trim();
  const icon=document.getElementById('ms-icon').value.trim();
  if(!name)return;
  ld();closeModal('modal-school');
  await db.from('schools').insert({id:'s'+Date.now(), name, icon});
  document.getElementById('ms-name').value='';
  await loadSchools();uh();
}
async function delSchool(id){
  if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙˆØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§ØŸ'))return;
  ld();
  await db.from('schools').delete().eq('id',id);
  await loadSchools();uh();
}

// ===== SCHOOL DETAIL =====
async function loadSchoolDetail(){
  ld();
  const s=schools.find(x=>x.id===curSchoolId);
  document.getElementById('sd-name').textContent=s?.name||'';
  document.getElementById('sd-icon').textContent=s?.icon||'ğŸ«';
  updateDeliveryBadge(s);
  await loadTheme();uh();
}
function setTheme(idx, btn){
  curTheme=idx;
  document.querySelectorAll('.ttab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  loadTheme();
}
async function saveDeliveryDate(){
  const d=document.getElementById('del-day').value;
  const m=document.getElementById('del-month').value;
  const y=document.getElementById('del-year').value;
  const s=schools.find(x=>x.id===curSchoolId);
  if(!s)return;
  s.delivery_year=y||null;
  s.delivery_month=m||null;
  s.delivery_day=d||null;
  await db.from('schools').update({delivery_year:y||null,delivery_month:m||null,delivery_day:d||null}).eq('id',curSchoolId);
  updateDeliveryBadge(s);
}
async function clearDeliveryDate(){
  const s=schools.find(x=>x.id===curSchoolId);
  if(!s)return;
  s.delivery_year=null;s.delivery_month=null;s.delivery_day=null;
  await db.from('schools').update({delivery_year:null,delivery_month:null,delivery_day:null}).eq('id',curSchoolId);
  document.getElementById('del-year').value='';
  document.getElementById('del-month').value='';
  document.getElementById('del-day').value='';
  updateDeliveryBadge(s);
}

// ===== THEME TABLE =====
async function loadTheme(){
  ld();
  const {data}=await db.from('school_themes').select('*').eq('school_id',curSchoolId).eq('theme_index',curTheme).order('sort_order');
  themeRows=data||[];
  renderThemeTable();uh();
}
function buildItemOpts(cat, selectedItem){
  const invItems=inventory.filter(x=>x.cat===cat);
  return `<option value="">-- Ø§Ø®ØªØ± --</option>`+
    invItems.map(x=>`<option value="${x.name}" ${x.name===selectedItem?'selected':''}>${x.name}</option>`).join('');
}
function renderThemeTable(){
  const tb=document.getElementById('theme-body');
  tb.innerHTML='';
  themeRows.forEach((row,i)=>{
    const qty=parseInt(row.qty)||0;
    const catOpts=['components','machines','kits','materials'].map(c=>`<option value="${c}" ${c===row.cat?'selected':''}>${catLabel(c)}</option>`).join('');
    const itemOpts=buildItemOpts(row.cat, row.item);
    const isNew=!!row._new;
    const tr=document.createElement('tr');
    tr.dataset.mode=isNew?'edit':'view';
    tr.dataset.idx=i;
    tr.innerHTML=`
      <td class="tdc">
        <span class="rv"${isNew?' style="display:none"':''}><span class="csel c${catAbbr(row.cat)}" style="padding:3px 9px;border-radius:18px;display:inline-block;font-weight:700;font-size:11px">${catLabel(row.cat)}</span></span>
        <span class="re"${isNew?'':' style="display:none"'}><select class="csel c${catAbbr(row.cat)}" onchange="onThemeCatInline(${i},this)">${catOpts}</select></span>
      </td>
      <td>
        <span class="rv"${isNew?' style="display:none"':' style="padding:9px 13px;display:block;font-size:12.5px"'}>${row.item||'<span style="color:var(--g400)">â€”</span>'}</span>
        <span class="re" id="item-cell-${i}"${isNew?'':' style="display:none"'}>
          <select class="isel" onchange="onThemeItemInline(${i},this)">${itemOpts}</select>
        </span>
      </td>
      <td class="tdq">
        <span class="rv"${isNew?' style="display:none"':' style="font-weight:700;color:var(--or);font-size:15px"'}>${qty}</span>
        <span class="re"${isNew?'':' style="display:none"'}>
          <div class="qctr">
            <button onclick="changeQty('theme',${i},-1)">âˆ’</button>
            <span id="qty-theme-${i}">${qty}</span>
            <button onclick="changeQty('theme',${i},1)">+</button>
          </div>
        </span>
      </td>
      <td>
        <span class="rv"${isNew?' style="display:none"':' style="padding:9px 13px;display:block;color:var(--g600);font-size:12.5px"'}>${row.note||'<span style="color:var(--g400)">â€”</span>'}</span>
        <span class="re"${isNew?'':' style="display:none"'}><textarea class="cedit" rows="1" oninput="ar(this)" onchange="themeRows[${i}].note=this.value">${row.note||''}</textarea></span>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('textarea').forEach(ar);
  themeRows.forEach((row,i)=>{
    if(row._new){
      const tr=tb.querySelectorAll('tr')[i];
      if(tr){const f=tr.querySelector('.re select');if(f)f.focus();}
    }
  });
}
function startThemeEdit(i){
  const tb=document.getElementById('theme-body');
  const tr=tb.querySelectorAll('tr')[i];
  if(!tr)return;
  tr.dataset.mode='edit';
  tr.querySelectorAll('.rv').forEach(el=>el.style.display='none');
  tr.querySelectorAll('.re').forEach(el=>el.style.display='');
  const first=tr.querySelector('.re select,.re input,.re textarea');
  if(first)first.focus();
}
function onThemeCatInline(i,sel){
  sel.className=`csel c${catAbbr(sel.value)}`;
  themeRows[i].cat=sel.value;
  themeRows[i].item='';
  const cell=document.getElementById('item-cell-'+i);
  if(cell){
    const isel=cell.querySelector('select');
    if(isel){
      isel.innerHTML=buildItemOpts(sel.value,'');
      isel.value='';
      setTimeout(()=>isel.focus(),50);
    }
  }
}
function onThemeItemInline(i,sel){
  themeRows[i].item=sel.value;
}
async function saveThemeRow(i){
  const r=themeRows[i];
  if(!r)return;
  if(!r.item){showToast('âš ï¸ Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù Ø£ÙˆÙ„Ø§Ù‹');return;}
  ld();
  if(r._new){
    delete r._new;
    await db.from('school_themes').insert({id:r.id,school_id:curSchoolId,theme_index:curTheme,cat:r.cat,item:r.item,qty:r.qty||0,note:r.note||'',sort_order:i});
  } else {
    await db.from('school_themes').update({cat:r.cat,item:r.item,qty:r.qty||0,note:r.note||''}).eq('id',r.id);
  }
  await loadTheme();
  uh();
  showToast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸');
}
function showToast(msg){
  let t=document.getElementById('toast-msg');
  if(!t){t=document.createElement('div');t.id='toast-msg';t.className='toast-msg';document.body.appendChild(t);}
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}
async function updateTheme(i,field,val){
  const r=themeRows[i];if(!r)return;
  r[field]=val;
}
async function addThemeRow(){
  const id='st'+Date.now();
  themeRows.push({id,school_id:curSchoolId,theme_index:curTheme,cat:'components',item:'',qty:0,note:'',sort_order:themeRows.length,_new:true});
  renderThemeTable();
}
async function delThemeRow(id,i){
  if(!confirm('ØªØ­Ø°Ù Ø§Ù„ØµÙØŸ'))return;
  ld();
  await db.from('school_themes').delete().eq('id',id);
  themeRows.splice(i,1);renderThemeTable();uh();
}

// ===== ANNUAL =====
async function loadAnnual(){
  ld();
  const s=schools.find(x=>x.id===curAnnualSchoolId);
  document.getElementById('an-title').textContent=(s?.icon||'ğŸ«')+' '+(s?.name||'')+' â€” Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©';
  const {data:yrs}=await db.from('school_years').select('*').eq('school_id',curAnnualSchoolId).order('created_at');
  const years=yrs||[];
  renderYearTabs(years);
  if(years.length>0){
    if(!curYear) curYear=years[0].id;
    await loadAnnualRows();
  } else {
    curYear=null;
    document.getElementById('annual-tables').innerHTML='<div style="text-align:center;padding:40px;color:var(--g400)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù†ÙˆØ§Øª Ø¯Ø±Ø§Ø³ÙŠØ© â€” Ø£Ø¶Ù Ø³Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>';
  }
  uh();
}
function renderYearTabs(years){
  const t=document.getElementById('yr-tabs');
  t.innerHTML='';
  years.forEach(y=>{
    const b=document.createElement('button');
    b.className='ttab'+(y.id===curYear?' active':'');
    b.textContent=y.name;
    b.onclick=()=>{curYear=y.id;document.querySelectorAll('.ttab').forEach(x=>x.classList.remove('active'));b.classList.add('active');loadAnnualRows();};
    t.appendChild(b);
  });
}
async function loadAnnualRows(){
  ld();
  const {data:themes}=await db.from('school_themes').select('*').eq('school_id',curAnnualSchoolId).order('theme_index').order('sort_order');
  annualRows=themes||[];
  renderAnnualTable();uh();
}
function renderAnnualTable(){
  const checks=document.querySelectorAll('#an-theme-filters input[type=checkbox]');
  const show=[checks[0]?.checked,checks[1]?.checked,checks[2]?.checked];
  const cont=document.getElementById('annual-tables');
  cont.innerHTML='';
  const tnames=['Theme One','Theme Two','Theme Three'];
  let grand={components:0,machines:0,kits:0,materials:0,total:0};
  [0,1,2].forEach(t=>{
    if(!show[t])return;
    const rows=annualRows.filter(r=>r.theme_index===t);
    if(!rows.length)return;
    const sec=document.createElement('div');
    sec.style.marginBottom='20px';
    let html=`<div style="font-size:14px;font-weight:800;color:var(--or);margin-bottom:10px;padding:8px 14px;background:var(--orb);border-radius:8px;border-right:4px solid var(--or)">${tnames[t]}</div>`;
    html+=`<div class="tcard"><table><thead><tr>
      <th class="tc">Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
      <th class="tq">Ø§Ù„Ø¹Ø¯Ø¯</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
    </tr></thead><tbody>`;
    let thTotal=0;
    rows.forEach((r,i)=>{
      const qty=parseInt(r.qty)||0;thTotal+=qty;grand[r.cat]=(grand[r.cat]||0)+qty;grand.total+=qty;
      html+=`<tr style="background:${i%2?'#fafafa':'#fff'}">
        <td style="padding:9px 13px"><span style="padding:3px 9px;border-radius:14px;font-size:11px;font-weight:700;background:${catBg(r.cat)};color:${catClr(r.cat)}">${catLabel(r.cat)}</span></td>
        <td style="padding:9px 13px">${r.item||'-'}</td>
        <td style="padding:9px 13px;text-align:center;font-weight:700;color:var(--or)">${qty}</td>
        <td style="padding:9px 13px;color:var(--g600)">${r.note||'-'}</td>
      </tr>`;
    });
    html+=`<tr style="background:#FFF7ED;font-weight:700"><td colspan="2" style="padding:9px 13px;color:var(--or)">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${tnames[t]}</td>
      <td style="padding:9px 13px;text-align:center;font-size:16px;color:var(--or)">${thTotal}</td><td></td></tr>`;
    html+=`</tbody></table></div>`;
    sec.innerHTML=html;cont.appendChild(sec);
  });
  if(grand.total>0){
    const gs=document.createElement('div');
    gs.style.cssText='background:linear-gradient(135deg,var(--or),var(--ord));border-radius:12px;padding:20px 24px;color:#fff;display:grid;grid-template-columns:repeat(5,1fr);gap:12px;text-align:center;margin-top:10px';
    gs.innerHTML=`
      <div><div style="font-size:20px;font-weight:800">${grand.components||0}</div><div style="font-size:11px;opacity:.8">Components</div></div>
      <div><div style="font-size:20px;font-weight:800">${grand.machines||0}</div><div style="font-size:11px;opacity:.8">Machines</div></div>
      <div><div style="font-size:20px;font-weight:800">${grand.kits||0}</div><div style="font-size:11px;opacity:.8">Kits</div></div>
      <div><div style="font-size:20px;font-weight:800">${grand.materials||0}</div><div style="font-size:11px;opacity:.8">Materials</div></div>
      <div style="border-right:1px solid rgba(255,255,255,.3)"><div style="font-size:24px;font-weight:900">${grand.total}</div><div style="font-size:11px;opacity:.8">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</div></div>`;
    cont.appendChild(gs);
  }
}
async function confirmAddYear(){
  const name=document.getElementById('my-name').value.trim();
  if(!name)return;
  ld();closeModal('modal-year');
  const id='y'+Date.now();
  await db.from('school_years').insert({id,school_id:curAnnualSchoolId,name});
  document.getElementById('my-name').value='';
  await loadAnnual();uh();
}

// ===== RETURNS =====
async function loadReturns(){
  ld();
  const s=schools.find(x=>x.id===curReturnSchoolId);
  document.getElementById('ret-title').textContent='â†©ï¸ Ù…Ø±ØªØ¬Ø¹Ø§Øª â€” '+(s?.name||'');
  const {data}=await db.from('school_returns').select('*').eq('school_id',curReturnSchoolId).order('created_at');
  returnRows=data||[];
  renderReturns();uh();
}
function renderReturns(){
  const tb=document.getElementById('returns-body');
  tb.innerHTML='';
  returnRows.forEach((row,i)=>{
    const catOpts=['components','machines','kits','materials'].map(c=>`<option value="${c}" ${c===row.cat?'selected':''}>${catLabel(c)}</option>`).join('');
    const itemOpts=buildItemOpts(row.cat,row.item);
    const qty=parseInt(row.qty)||0;
    const isNew=!!row._new;
    const tr=document.createElement('tr');
    tr.dataset.mode=isNew?'edit':'view';
    tr.dataset.idx=i;
    tr.dataset.table='ret';
    tr.innerHTML=`
      <td class="tdc">
        <span class="rv"${isNew?' style="display:none"':''}><span class="csel c${catAbbr(row.cat)}" style="padding:3px 9px;border-radius:18px;display:inline-block;font-weight:700;font-size:11px">${catLabel(row.cat)}</span></span>
        <span class="re"${isNew?'':' style="display:none"'}><select class="csel c${catAbbr(row.cat)}" onchange="onRetCatInline(${i},this)">${catOpts}</select></span>
      </td>
      <td>
        <span class="rv"${isNew?' style="display:none"':' style="padding:9px 13px;display:block;font-size:12.5px"'}>${row.item||'<span style="color:var(--g400)">â€”</span>'}</span>
        <span class="re" id="ret-item-cell-${i}"${isNew?'':' style="display:none"'}>
          <select class="isel" onchange="returnRows[${i}].item=this.value">${itemOpts}</select>
        </span>
      </td>
      <td class="tdq">
        <span class="rv"${isNew?' style="display:none"':' style="font-weight:700;color:var(--or);font-size:15px"'}>${qty}</span>
        <span class="re"${isNew?'':' style="display:none"'}>
          <div class="qctr">
            <button onclick="changeQty('ret',${i},-1)">âˆ’</button>
            <span id="qty-ret-${i}">${qty}</span>
            <button onclick="changeQty('ret',${i},1)">+</button>
          </div>
        </span>
      </td>
      <td>
        <span class="rv"${isNew?' style="display:none"':' style="padding:9px 13px;display:block;color:var(--g600);font-size:12.5px"'}>${row.reason||'<span style="color:var(--g400)">â€”</span>'}</span>
        <span class="re"${isNew?'':' style="display:none"'}><textarea class="cedit" rows="1" oninput="ar(this)" onchange="returnRows[${i}].reason=this.value">${row.reason||''}</textarea></span>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('textarea').forEach(ar);
  returnRows.forEach((row,i)=>{
    if(row._new){
      const tr=tb.querySelectorAll('tr')[i];
      if(tr){const f=tr.querySelector('.re select');if(f)f.focus();}
    }
  });
}
function startRetEdit(i){
  const tb=document.getElementById('returns-body');
  const tr=tb.querySelectorAll('tr')[i];
  if(!tr)return;
  tr.dataset.mode='edit';
  tr.querySelectorAll('.rv').forEach(el=>el.style.display='none');
  tr.querySelectorAll('.re').forEach(el=>el.style.display='');
  const first=tr.querySelector('.re select,.re input,.re textarea');
  if(first)first.focus();
}
function onRetCatInline(i,sel){
  sel.className=`csel c${catAbbr(sel.value)}`;
  returnRows[i].cat=sel.value;
  returnRows[i].item='';
  const cell=document.getElementById('ret-item-cell-'+i);
  if(cell){
    const isel=cell.querySelector('select');
    if(isel){isel.innerHTML=buildItemOpts(sel.value,'');isel.value='';setTimeout(()=>isel.focus(),50);}
  }
}
async function saveRetRow(i){
  const r=returnRows[i];
  if(!r)return;
  if(!r.item){showToast('âš ï¸ Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù Ø£ÙˆÙ„Ø§Ù‹');return;}
  ld();
  if(r._new){
    delete r._new;
    await db.from('school_returns').insert({id:r.id,school_id:curReturnSchoolId,cat:r.cat,item:r.item,qty:r.qty||0,reason:r.reason||''});
  } else {
    await db.from('school_returns').update({cat:r.cat,item:r.item,qty:r.qty||0,reason:r.reason||''}).eq('id',r.id);
  }
  await loadReturns();uh();showToast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸');
}
async function addReturnRow(){
  const id='sr'+Date.now();
  returnRows.push({id,school_id:curReturnSchoolId,cat:'components',item:'',qty:0,reason:'',_new:true});
  renderReturns();
}
async function delRetRow(id,i){
  if(!confirm('ØªØ­Ø°Ù Ø§Ù„ØµÙØŸ'))return;
  ld();
  await db.from('school_returns').delete().eq('id',id);
  returnRows.splice(i,1);renderReturns();uh();
}

// ===== INVENTORY =====
async function loadInventory(){
  ld();
  const {data}=await db.from('inventory').select('*').order('cat').order('name');
  inventory=data||[];
  await renderInventory();uh();
}
async function calcPulled(name){
  const {data}=await db.from('school_themes').select('qty').eq('item',name);
  return (data||[]).reduce((s,r)=>s+(+r.qty||0),0);
}
async function renderInventory(){
  updateInvStats();
  const tb=document.getElementById('inv-body');
  tb.innerHTML='<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--g400)">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...</td></tr>';
  const rows=await Promise.all(inventory.map(async r=>({r,p:await calcPulled(r.name)})));
  tb.innerHTML='';
  rows.forEach(({r,p},i)=>{
    const catOpts=['components','machines','kits','materials'].map(c=>`<option value="${c}" ${c===r.cat?'selected':''}>${catLabel(c)}</option>`).join('');
    const isNew=!!r._new;
    const tr=document.createElement('tr');
    tr.dataset.mode=isNew?'edit':'view';
    tr.dataset.idx=i;
    tr.innerHTML=`
      <td class="tdc">
        <span class="rv"${isNew?' style="display:none"':''}><span class="csel c${catAbbr(r.cat)}" style="padding:3px 9px;border-radius:18px;display:inline-block;font-weight:700;font-size:11px">${catLabel(r.cat)}</span></span>
        <span class="re"${isNew?'':' style="display:none"'}><select class="csel c${catAbbr(r.cat)}" onchange="this.className='csel c'+catAbbr(this.value);inventory[${i}].cat=this.value;updateInvStats()">${catOpts}</select></span>
      </td>
      <td>
        <span class="rv"${isNew?' style="display:none"':' style="padding:9px 13px;display:block;font-size:12.5px"'}>${r.name}</span>
        <span class="re"${isNew?'':' style="display:none"'}><textarea class="cedit" rows="1" oninput="ar(this)" onchange="inventory[${i}].name=this.value">${r.name}</textarea></span>
      </td>
      <td class="tdq" style="color:var(--or);font-weight:700;font-size:16px">${p}</td>
      <td>
        <span class="rv"${isNew?' style="display:none"':' style="padding:9px 13px;display:block;color:var(--g600);font-size:12.5px"'}>${r.note||'<span style="color:var(--g400)">â€”</span>'}</span>
        <span class="re"${isNew?'':' style="display:none"'}><textarea class="cedit" rows="1" oninput="ar(this)" onchange="inventory[${i}].note=this.value">${r.note||''}</textarea></span>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('textarea').forEach(ar);
}
function startInvEdit(i){
  const tb=document.getElementById('inv-body');
  const tr=tb.querySelectorAll('tr')[i];
  if(!tr)return;
  tr.dataset.mode='edit';
  tr.querySelectorAll('.rv').forEach(el=>el.style.display='none');
  tr.querySelectorAll('.re').forEach(el=>el.style.display='');
  const first=tr.querySelector('.re select,.re input,.re textarea');
  if(first)first.focus();
}
async function saveInvRow(i){
  const r=inventory[i];if(!r)return;
  if(!r.name||!r.name.trim()){showToast('âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù');return;}
  ld();
  if(r._new){
    delete r._new;
    await db.from('inventory').insert({id:r.id,cat:r.cat,name:r.name,note:r.note||''});
  } else {
    await db.from('inventory').update({cat:r.cat,name:r.name,note:r.note||''}).eq('id',r.id);
  }
  await loadInventory();uh();showToast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸');
}
function updateInvStats(){
  ['components','machines','kits','materials'].forEach(c=>{
    const el=document.getElementById('st-'+c);
    if(el) el.textContent=inventory.filter(r=>r.cat===c).length;
  });
}
async function addInvRow(){
  const id='i'+Date.now();
  inventory.push({id,cat:'components',name:'',note:'',_new:true});
  await renderInventory();
}
async function delInvRow(id,i){
  if(!confirm('ØªØ­Ø°Ù Ø§Ù„ØµÙ†ÙØŸ'))return;ld();
  await db.from('inventory').delete().eq('id',id);
  inventory.splice(i,1);await renderInventory();uh();
}

// ===== TECH DAY =====
const tdTables={prep:'tdprep-body',recv:'tdrecv-body',check:'tdcheck-body'};
async function loadTD(type){
  ld();
  const {data}=await db.from('techday_'+type).select('*').order('sort_order');
  if(type==='prep') tdPrep=data||[];
  else if(type==='recv') tdRecv=data||[];
  else tdCheck=data||[];
  renderTD(type);uh();
}
function renderTD(type){
  const tb=document.getElementById(tdTables[type]);
  if(!tb)return;
  tb.innerHTML='';
  const rows=type==='prep'?tdPrep:type==='recv'?tdRecv:tdCheck;
  const NB=['#eff6ff;#3b82f6','#f5f3ff;#8b5cf6','#ecfdf5;#10b981','#fffbeb;#f59e0b',
    '#fef2f2;#ef4444','#ecfeff;#06b6d4','#fdf2f8;#ec4899','#fff7ed;#f97316','#eef2ff;#6366f1','#f0fdfa;#14b8a6'];
  rows.forEach((row,i)=>{
    const [bg,clr]=NB[i%NB.length].split(';');
    const tr=document.createElement('tr');
    tr.dataset.idx=i;
    if(type==='prep'){
      tr.innerHTML=`
        <td style="text-align:center;vertical-align:middle;padding:9px 5px">
          <span style="display:inline-flex;width:26px;height:26px;border-radius:7px;align-items:center;justify-content:center;font-size:11px;font-weight:800;background:${bg};color:${clr}">${i+1}</span>
        </td>
        <td><textarea class="cedit" style="font-weight:700" rows="1" oninput="ar(this)" onchange="updateTD('prep','${row.id}','name',this.value)">${row.name||''}</textarea></td>
        <td><textarea class="cedit" style="color:var(--g600);font-size:12px" rows="1" oninput="ar(this)" onchange="updateTD('prep','${row.id}','detail',this.value)">${row.detail||''}</textarea></td>
        <td><textarea class="cedit" style="color:var(--g600);font-size:12px" rows="1" placeholder="Ù…ÙƒÙˆÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..." oninput="ar(this)" onchange="updateTD('prep','${row.id}','extra',this.value)">${row.extra||''}</textarea></td>`;
    } else if(type==='recv'){
      const invItems=inventory.filter(x=>x.cat===row.cat);
      const isC=row.item&&!invItems.find(x=>x.name===row.item);
      const catOpts=['components','machines','kits','materials'].map(c=>`<option value="${c}" ${c===row.cat?'selected':''}>${catLabel(c)}</option>`).join('');
      let itemOpts=`<option value="">-- Ø§Ø®ØªØ± --</option>`+
        invItems.map(x=>`<option value="${x.name}" ${x.name===row.item?'selected':''}>${x.name}</option>`).join('')+
        `<option value="__c__" ${isC?'selected':''}>âœï¸ ÙŠØ¯ÙˆÙŠ</option>`;
      const statOpts=['Ù„Ù… ÙŠÙØ³ØªÙ„Ù…','Ù…ÙƒØªÙ…Ù„','Ù†Ø§Ù‚Øµ','ØªØ§Ù„Ù'].map(s=>`<option ${s===row.status?'selected':''}>${s}</option>`).join('');
      const qty=parseInt(row.qty)||0;
      tr.innerHTML=`
        <td class="tdc"><select class="csel c${catAbbr(row.cat||'components')}" onchange="onTDRecvCat(${i},this)">${catOpts}</select></td>
        <td>
          <select class="isel" onchange="onTDRecvItem(${i},this)">${itemOpts}</select>
          <input type="text" class="cedit" style="display:${isC?'block':'none'};padding-top:0;min-height:28px" value="${isC?row.item:''}" onchange="updateTD('recv','${row.id}','item',this.value)">
        </td>
        <td class="tdq">
          <div class="qctr">
            <button onclick="changeQty('tdrecv',${i},-1)">âˆ’</button>
            <span id="qty-tdrecv-${i}">${qty}</span>
            <button onclick="changeQty('tdrecv',${i},1)">+</button>
          </div>
        </td>
        <td><select class="isel" style="color:${row.status==='Ù…ÙƒØªÙ…Ù„'?'#16A34A':row.status==='ØªØ§Ù„Ù'?'#ef4444':'var(--g800)'}" onchange="updateTD('recv','${row.id}','status',this.value)">${statOpts}</select></td>`;
    } else {
      tr.innerHTML=`
        <td style="text-align:center;vertical-align:middle;padding:9px 5px">
          <input type="checkbox" ${row.done?'checked':''} style="width:16px;height:16px;accent-color:var(--or)" onchange="updateTD('check','${row.id}','done',this.checked)">
        </td>
        <td><textarea class="cedit" rows="1" oninput="ar(this)" style="${row.done?'text-decoration:line-through;color:var(--g400)':''}" onchange="updateTD('check','${row.id}','name',this.value)">${row.name||''}</textarea></td>`;
    }
    tb.appendChild(tr);
  });
  tb.querySelectorAll('textarea').forEach(ar);
}
async function updateTD(type,id,field,val){
  await db.from('techday_'+type).update({[field]:val}).eq('id',id);
  if(type==='check' && field==='done') loadTD('check');
}
async function addTD(type){
  const id='td'+Date.now();
  const rows=type==='prep'?tdPrep:type==='recv'?tdRecv:tdCheck;
  const obj={id,sort_order:rows.length};
  if(type==='prep') obj.name='';
  else if(type==='recv'){obj.cat='components';obj.item='';obj.qty=0;obj.status='Ù„Ù… ÙŠÙØ³ØªÙ„Ù…';}
  else obj.name='';
  await db.from('techday_'+type).insert(obj);
  loadTD(type);
}
async function delTD(type,id,i){
  if(!confirm('ØªØ­Ø°ÙØŸ'))return;ld();
  await db.from('techday_'+type).delete().eq('id',id);
  loadTD(type);uh();
}

// ===== AUDIT =====
async function loadAudit(){
  ld();
  const {data:sc}=await db.from('schools').select('*').order('created_at');
  const cont=document.getElementById('audit-content');
  cont.innerHTML='';
  for(const s of (sc||[])){
    const sec=document.createElement('div');
    sec.style.marginBottom='28px';
    let html=`<div style="font-size:16px;font-weight:800;color:var(--g900);margin-bottom:14px;padding:10px 16px;background:var(--orb);border-radius:10px;border-right:4px solid var(--or)">${s.icon||'ğŸ«'} ${s.name}</div>`;
    for(let t=0;t<3;t++){
      const {data:rows}=await db.from('school_themes').select('*').eq('school_id',s.id).eq('theme_index',t).order('sort_order');
      if(!rows?.length)continue;
      const tnames=['Theme One','Theme Two','Theme Three'];
      html+=`<div style="font-size:12px;font-weight:700;color:var(--or);margin:10px 0 6px">${tnames[t]}</div>`;
      html+=`<div class="tcard"><table><thead><tr>
        <th class="tc">Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th class="tq">Ø§Ù„Ø¹Ø¯Ø¯</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
      </tr></thead><tbody>`;
      rows.forEach((r,i)=>{
        html+=`<tr style="background:${i%2?'#fafafa':'#fff'}">
          <td style="padding:8px 12px"><span style="padding:2px 8px;border-radius:12px;font-size:10px;font-weight:700;background:${catBg(r.cat)};color:${catClr(r.cat)}">${catLabel(r.cat)}</span></td>
          <td style="padding:8px 12px">${r.item||'-'}</td>
          <td style="padding:8px 12px;text-align:center;font-weight:700;color:var(--or)">${r.qty||0}</td>
          <td style="padding:8px 12px;color:var(--g600)">${r.note||'-'}</td>
        </tr>`;
      });
      html+=`</tbody></table></div>`;
    }
    sec.innerHTML=html;cont.appendChild(sec);
  }
  uh();
}

// ===== UTILS =====
function catLabel(c){return {components:'Components',machines:'Machines',kits:'Kits',materials:'Materials'}[c]||c;}
function catAbbr(c){return {components:'c',machines:'m',kits:'k',materials:'mt'}[c]||'c';}
function catBg(c){return {components:'#EFF6FF',machines:'#F0FDF4',kits:'#FFF7ED',materials:'#FAF5FF'}[c]||'#f3f4f6';}
function catClr(c){return {components:'#2563EB',machines:'#16A34A',kits:'#EA580C',materials:'#9333EA'}[c]||'#374151';}
function ar(el){el.style.height='auto';el.style.height=el.scrollHeight+'px';}

// QTY COUNTER
async function changeQty(type,i,delta){
  let row,field='qty',tbl;
  if(type==='theme'){row=themeRows[i];tbl='school_themes';}
  else if(type==='ret'){row=returnRows[i];tbl='school_returns';}
  else if(type==='tdrecv'){row=tdRecv[i];tbl='techday_recv';}
  if(!row)return;
  const newQty=Math.max(0,(parseInt(row.qty)||0)+delta);
  row.qty=newQty;
  const span=document.getElementById(`qty-${type}-${i}`);
  if(span)span.textContent=newQty;
  if(type!=='theme'){
    await db.from(tbl).update({qty:newQty}).eq('id',row.id);
  }
}

// ENTER KEY - smart navigation/save
document.addEventListener('keydown',e=>{
  if(e.key!=='Enter')return;
  const el=e.target;
  if(!el.matches('select,input,textarea'))return;
  const tbody=el.closest('tbody');
  if(!tbody)return;
  const isTheme=tbody.id==='theme-body';
  const isRet=tbody.id==='returns-body';
  const isInv=tbody.id==='inv-body';
  if(!isTheme && !isRet && !isInv)return;
  
  e.preventDefault();
  const curRow=el.closest('tr');
  if(!curRow)return;
  const idx=parseInt(curRow.dataset.idx);
  
  if(el.classList.contains('csel')){
    const itemSel=curRow.querySelector('.isel') || curRow.querySelector('textarea');
    if(itemSel) itemSel.focus();
    return;
  }
  if(el.classList.contains('isel')){
    const note=curRow.querySelector('textarea');
    if(note) note.focus();
    else if(!isNaN(idx)){
      if(isTheme) saveThemeRow(idx);
      else if(isRet) saveRetRow(idx);
    }
    return;
  }
  if(!isNaN(idx)){
    if(isTheme) saveThemeRow(idx);
    else if(isRet) saveRetRow(idx);
    else if(isInv) saveInvRow(idx);
  }
});

// ===== INIT =====
async function init(){
  ld();
  const {data:inv}=await db.from('inventory').select('*').order('cat').order('name');
  inventory=inv||[];
  const {data:sc}=await db.from('schools').select('*').order('created_at');
  schools=sc||[];
  history.replaceState({page:'home'},'','#home');
  uh();
}
</script>
</body>
</html>
