<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pyramakerz â€” Operation System</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --or:#F97316; --ord:#EA580C; --orb:#FFF7ED; --orbd:#FED7AA;
      --g50:#F9FAFB; --g100:#F3F4F6; --g200:#E5E7EB; --g300:#D1D5DB;
      --g400:#9CA3AF; --g600:#4B5563; --g800:#1F2937; --g900:#111827;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI','Tahoma',sans-serif;background:var(--g50);color:var(--g900);min-height:100vh}
    button, input, select, textarea{font-family:inherit}
    a{color:inherit}

    /* Topbar */
    .topbar{background:#fff;border-bottom:2px solid var(--orbd);padding:0 24px;height:60px;
      display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;box-shadow:0 2px 10px rgba(249,115,22,.07)}
    .tb-logo{display:flex;align-items:center;gap:10px;cursor:pointer}
    .tb-logo img{height:34px}
    .tb-title{font-size:13px;font-weight:800;letter-spacing:1px;color:var(--g800)}
    .tb-right{display:flex;align-items:center;gap:10px}
    .tb-back{display:none;align-items:center;gap:6px;padding:6px 12px;background:var(--orb);border:1px solid var(--orbd);border-radius:10px;color:var(--ord);
      font-size:13px;font-weight:700;cursor:pointer}
    .tb-back.show{display:flex}
    .tb-logout{padding:7px 12px;background:var(--g200);border:none;border-radius:10px;color:var(--g800);font-weight:800;font-size:12px;cursor:pointer}
    .tb-logout:hover{background:var(--g300)}
    .sdot{width:7px;height:7px;border-radius:50%;background:#10b981;display:inline-block;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
    .slbl{color:var(--g400);font-size:11px;font-weight:700}

    /* Pages */
    #app{display:none}
    .page{display:none;padding:26px}
    .page.active{display:block}

    /* Login */
    #login{position:fixed;inset:0;background:linear-gradient(135deg,#fff7ed,#fff,#fff7ed);display:flex;align-items:center;justify-content:center;z-index:999}
    .lcard{background:#fff;border-radius:22px;padding:40px 34px;width:min(420px,92vw);text-align:center;
      box-shadow:0 20px 60px rgba(249,115,22,.15);border:1px solid var(--orbd)}
    .ltitle{font-size:12px;font-weight:900;color:var(--g600);letter-spacing:2px;text-transform:uppercase;margin-bottom:18px}
    .lrow{display:flex;flex-direction:column;gap:10px}
    .linput{width:100%;padding:12px 14px;border:2px solid var(--g200);border-radius:12px;outline:none;font-size:14px}
    .linput:focus{border-color:var(--or)}
    .lbtn{width:100%;padding:12px;background:var(--or);color:#fff;border:none;border-radius:12px;font-weight:900;cursor:pointer}
    .lbtn:hover{background:var(--ord)}
    .lerr{margin-top:10px;color:#ef4444;font-size:12px;font-weight:800;display:none}

    /* Home cards */
    .hero{background:linear-gradient(135deg,var(--or),var(--ord));border-radius:18px;padding:34px 34px;margin-bottom:22px;color:#fff;position:relative;overflow:hidden}
    .hero:before{content:'';position:absolute;top:-50px;right:-30px;width:220px;height:220px;background:rgba(255,255,255,.08);border-radius:50%}
    .hero:after{content:'';position:absolute;bottom:-70px;left:70px;width:270px;height:270px;background:rgba(0,0,0,.06);border-radius:50%}
    .hero-in{position:relative;z-index:2}
    .htag{font-size:10px;font-weight:900;letter-spacing:3px;text-transform:uppercase;opacity:.75;margin-bottom:8px}
    .htitle{font-size:30px;font-weight:900;line-height:1.15}
    .hsub{font-size:13px;opacity:.8;margin-top:6px}

    .cgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    .mcard{background:#fff;border-radius:18px;padding:26px 22px;cursor:pointer;border:2px solid var(--g200);
      transition:all .25s cubic-bezier(.34,1.56,.64,1);position:relative;overflow:hidden}
    .mcard:hover{border-color:var(--or);transform:translateY(-4px);box-shadow:0 18px 36px rgba(249,115,22,.14)}
    .cicon{width:54px;height:54px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px;margin-bottom:14px}
    .io{background:linear-gradient(135deg,#FFF7ED,#FED7AA)}
    .ib{background:linear-gradient(135deg,#EFF6FF,#BFDBFE)}
    .ig{background:linear-gradient(135deg,#F0FDF4,#BBF7D0)}
    .ip{background:linear-gradient(135deg,#FAF5FF,#E9D5FF)}
    .cname{font-size:18px;font-weight:900;margin-bottom:6px}
    .cdesc{font-size:12px;color:var(--g400);line-height:1.6}
    .carrow{position:absolute;bottom:18px;left:18px;width:30px;height:30px;border-radius:50%;background:var(--orb);display:flex;align-items:center;justify-content:center;color:var(--or);font-weight:900}

    /* Page header */
    .ph{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:16px}
    .ptitle{font-size:22px;font-weight:900}
    .btn{padding:10px 16px;background:var(--or);color:#fff;border:none;border-radius:12px;font-weight:900;font-size:13px;cursor:pointer}
    .btn:hover{background:var(--ord)}
    .btn.secondary{background:var(--g200);color:var(--g800)}
    .btn.secondary:hover{background:var(--g300)}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    /* Filters */
    .filters{background:#fff;border:1px solid var(--g200);border-radius:14px;padding:14px;margin-bottom:16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .fgrp{display:flex;gap:8px;align-items:center}
    .flbl{font-size:12px;font-weight:900;color:var(--g600)}
    .fsel{padding:8px 10px;border:2px solid var(--g200);border-radius:12px;outline:none;background:var(--g50);font-weight:800}
    .fsel:focus{border-color:var(--or)}
    .hint{font-size:12px;color:var(--g400);font-weight:800}

    /* Tables */
    .tcard{background:#fff;border:1px solid var(--g200);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.04);overflow:hidden}
    .table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
    table{width:100%;border-collapse:collapse;min-width:820px}
    thead tr{background:linear-gradient(135deg,var(--ord),var(--or))}
    thead th{padding:12px 12px;color:#fff;font-size:11px;font-weight:900;text-align:right;white-space:nowrap}
    tbody td{border-bottom:1px solid #f3f4f6;vertical-align:middle}
    tbody tr:nth-child(even){background:#fafafa}
    tbody tr:hover{background:#FFF7ED}
    .tdp{padding:10px 12px}
    .tcenter{text-align:center}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace}
    .small{font-size:11px;color:var(--g400);font-weight:800}

    /* Qty counter (same in all tables) */
    .qctr{display:inline-flex;align-items:center;border:2px solid var(--g200);border-radius:10px;overflow:hidden;background:#fff}
    .qctr button{background:none;border:none;padding:6px 10px;font-size:16px;font-weight:900;color:var(--g600);cursor:pointer;line-height:1}
    .qctr button:hover{background:var(--orb);color:var(--or)}
    .qctr span{min-width:36px;text-align:center;font-size:13px;font-weight:900;color:var(--g900);padding:6px 2px}
    .qctr.disabled button{opacity:.4;cursor:not-allowed}
    .qctr.disabled button:hover{background:none;color:var(--g600)}

    /* Row actions (no header dots) */
    .act{display:inline-flex;align-items:center;justify-content:center}
    .actbtn{background:var(--g100);border:1px solid var(--g200);border-radius:10px;padding:6px 10px;font-weight:900;cursor:pointer;color:var(--g800)}
    .actbtn:hover{background:var(--g200)}
    .tag{display:inline-flex;align-items:center;gap:6px;background:var(--orb);border:1px solid var(--orbd);padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;color:var(--ord)}
    .tag.arch{background:#EEF2FF;border-color:#C7D2FE;color:#3730A3}

    /* Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;align-items:center;justify-content:center;padding:18px}
    .modal.on{display:flex}
    .mcard2{background:#fff;border-radius:18px;max-width:520px;width:100%;padding:20px 18px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .mtitle{font-size:16px;font-weight:1000;margin-bottom:10px}
    .mrow{display:flex;gap:10px;flex-wrap:wrap}
    .minput, .mtextarea, .mselect{width:100%;padding:10px 12px;border:2px solid var(--g200);border-radius:12px;outline:none}
    .minput:focus,.mtextarea:focus,.mselect:focus{border-color:var(--or)}
    .mtextarea{min-height:90px;resize:vertical}
    .mactions{display:flex;justify-content:flex-end;gap:10px;margin-top:14px}
    .danger{background:#ef4444}
    .danger:hover{background:#dc2626}

    /* Responsive */
    @media (max-width: 900px){
      .cgrid{grid-template-columns:1fr}
      .page{padding:16px}
      table{min-width:720px}
      .topbar{padding:0 16px}
    }
  </style>
</head>
<body>

<!-- Login -->
<div id="login">
  <div class="lcard">
    <div style="display:flex;justify-content:center;margin-bottom:12px">
      <img alt="logo" style="height:52px" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='260' height='70'%3E%3Ctext x='0' y='50' font-size='44' font-family='Segoe UI' font-weight='700' fill='%23EA580C'%3EPyramakerz%3C/text%3E%3C/svg%3E" />
    </div>
    <div class="ltitle">Pyramakerz â€” Login</div>
    <div class="lrow">
      <input id="email" class="linput" type="email" placeholder="Email" autocomplete="username" />
      <input id="password" class="linput" type="password" placeholder="Password" autocomplete="current-password" />
      <button id="loginBtn" class="lbtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
    <div id="loginErr" class="lerr"></div>
  </div>
</div>

<!-- App -->
<div id="app">
  <div class="topbar">
    <div class="tb-logo" id="homeBtn">
      <img alt="logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='34'%3E%3Ctext x='0' y='24' font-size='20' font-family='Segoe UI' fill='%23EA580C'%3EPyramakerz%3C/text%3E%3C/svg%3E" />
      <div class="tb-title">Operation System</div>
    </div>
    <div class="tb-right">
      <button id="backBtn" class="tb-back">Ø±Ø¬ÙˆØ¹</button>
      <span class="sdot"></span><span class="slbl">Ù…ØªØµÙ„</span>
      <button id="logoutBtn" class="tb-logout">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <!-- HOME -->
  <div id="p-home" class="page active">
    <div class="hero">
      <div class="hero-in">
        <div class="htag">OPERATIONS</div>
        <div class="htitle">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
        <div class="hsub" id="activeYearLbl"></div>
      </div>
    </div>

    <div class="cgrid">
      <div class="mcard" data-nav="p-inventory">
        <div class="cicon io">ğŸ“¦</div>
        <div class="cname">Inventory</div>
        <div class="cdesc">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù ÙˆØ§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ.</div>
        <div class="carrow">â†©</div>
      </div>

      <div class="mcard" data-nav="p-schools">
        <div class="cicon ib">ğŸ«</div>
        <div class="cname">Schools</div>
        <div class="cdesc">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ÙˆØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ø³Ù†Ø©/Ø§Ù„Ø´Ù‡Ø±.</div>
        <div class="carrow">â†©</div>
      </div>

      <div class="mcard" data-nav="p-extra">
        <div class="cicon ig">â•</div>
        <div class="cname">Extra Requests</div>
        <div class="cdesc">Ø·Ù„Ø¨Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (ØªØ³Ø¬ÙŠÙ„ ØªÙˆØ²ÙŠØ¹ Ø¥Ø¶Ø§ÙÙŠ).</div>
        <div class="carrow">â†©</div>
      </div>

      <div class="mcard" data-nav="p-audit">
        <div class="cicon ip">ğŸ“Š</div>
        <div class="cname">Audit</div>
        <div class="cdesc">Ø¬Ø±Ø¯ Ø¢Ø®Ø± Ø§Ù„Ø³Ù†Ø©: Ù…Ù„Ø®Øµ Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø© Ø£Ùˆ Ø´Ù‡Ø±.</div>
        <div class="carrow">â†©</div>
      </div>

      <div class="mcard" data-nav="p-daily">
        <div class="cicon ib">âœ…</div>
        <div class="cname">Daily Tasks</div>
        <div class="cdesc">Ù…Ù‡Ø§Ù… ÙŠÙˆÙ…ÙŠØ© + Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­).</div>
        <div class="carrow">â†©</div>
      </div>

      <div class="mcard" data-nav="p-reports">
        <div class="cicon ip">ğŸ§¾</div>
        <div class="cname">Reports & Forms</div>
        <div class="cdesc">Ù‚Ø§Ù„Ø¨ Ù„Ù„Ù€ Reports / Forms (Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙˆØ³Ø¹Ø©).</div>
        <div class="carrow">â†©</div>
      </div>
    </div>
  </div>

  <!-- INVENTORY -->
  <div id="p-inventory" class="page">
    <div class="ph">
      <div class="ptitle">Inventory</div>
      <button class="btn" id="addInvBtn" class="btn admin-only">+ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
    </div>

    <div class="tcard">
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>ÙƒÙˆØ¯</th>
              <th>Ø§Ù„ØµÙ†Ù</th>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th class="tcenter">Ø§Ù„Ø¹Ø¯Ø¯</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
              <th class="tcenter"></th>
            </tr>
          </thead>
          <tbody id="invBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- SCHOOLS -->
  <div id="p-schools" class="page">
    <div class="ph">
      <div class="ptitle">Schools</div>
      <button class="btn" id="addSchoolBtn" class="btn admin-only">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø±Ø³Ø©</button>
    </div>

    <div class="filters">
      <div class="fgrp">
        <div class="flbl">Year</div>
        <select id="schoolYearSel" class="fsel"></select>
      </div>
      <div class="fgrp">
        <div class="flbl">Month</div>
        <select id="schoolMonthSel" class="fsel"></select>
      </div>
      <span id="yearTag" class="tag"></span>
      <span class="hint">Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª. (Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø³Ù…ÙˆØ­Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù†Ø´Ø·Ø©)</span>
    </div>

    <div class="tcard">
      <div class="table-scroll">
        <table style="min-width:900px">
          <thead>
            <tr>
              <th>ÙƒÙˆØ¯</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th>
              <th>Ø¥Ø¯Ø§Ø±Ø©/Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
              <th class="tcenter"> </th>
            </tr>
          </thead>
          <tbody id="schoolsBody"></tbody>
        </table>
      </div>
    </div>

    <div id="schoolDetails" style="margin-top:16px;display:none">
      <div class="ph">
        <div class="ptitle" id="schoolDetailsTitle">ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
        <button class="btn" id="addDistBtn" class="btn admin-only">+ Ø¥Ø¶Ø§ÙØ© ØªÙˆØ²ÙŠØ¹</button>
      </div>

      <div class="tcard">
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„ØµÙ†Ù</th>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th class="tcenter">Ø§Ù„Ù…Ø±Ø³Ù„Ø©</th>
                <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                <th class="tcenter"></th>
              </tr>
            </thead>
            <tbody id="distBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- EXTRA REQUESTS -->
  <div id="p-extra" class="page">
    <div class="ph">
      <div class="ptitle">Extra Requests</div>
      <button class="btn" id="addExtraBtn" class="btn admin-only">+ Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨</button>
    </div>

    <div class="filters">
      <div class="fgrp"><div class="flbl">Year</div><select id="extraYearSel" class="fsel"></select></div>
      <div class="fgrp"><div class="flbl">Month</div><select id="extraMonthSel" class="fsel"></select></div>
      <span id="extraYearTag" class="tag"></span>
      <span class="hint">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© = ØªÙˆØ²ÙŠØ¹Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (ØªØ³Ù…Ø­ Ø¨ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„ØµÙ†Ù ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø´Ù‡Ø±).</span>
    </div>

    <div class="tcard">
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th>
              <th>Ø§Ù„ØµÙ†Ù</th>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th class="tcenter">Ø§Ù„Ù…Ø±Ø³Ù„Ø©</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
              <th class="tcenter"></th>
            </tr>
          </thead>
          <tbody id="extraBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- AUDIT -->
  <div id="p-audit" class="page">
    <div class="ph">
      <div class="ptitle">Audit</div>
      <div class="small">Ø§Ù„Ø¬Ø±Ø¯ ÙŠÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¶Ø§ÙØ© Ù…Ù† Ù‡Ù†Ø§).</div>
    </div>

    <div class="filters">
      <div class="fgrp"><div class="flbl">School</div><select id="auditSchoolSel" class="fsel"></select></div>
      <div class="fgrp"><div class="flbl">Year</div><select id="auditYearSel" class="fsel"></select></div>
      <div class="fgrp"><div class="flbl">Month</div><select id="auditMonthSel" class="fsel"></select></div>
      <span class="hint">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ø®ØªÙŠØ§Ø±ÙŠ. Ø§Ù„Ø³Ù†Ø© Ù…Ø·Ù„ÙˆØ¨Ø©. Ø§Ù„Ø´Ù‡Ø± Ø§Ø®ØªÙŠØ§Ø±ÙŠ.</span>
    </div>

    <div class="tcard">
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„ØµÙ†Ù</th>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th class="tcenter">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø³Ù„</th>
              <th class="tcenter">Ø§Ù„ÙØ¹Ù„ÙŠØ©</th>
              <th class="tcenter">Ø§Ù„ØªÙˆØ§Ù„Ù</th>
            </tr>
          </thead>
          <tbody id="auditBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- DAILY TASKS -->
  <div id="p-daily" class="page">
    <div class="ph">
      <div class="ptitle">Daily Tasks</div>
      <button class="btn" id="addTaskBtn" class="btn admin-only">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©</button>
    </div>

    <div class="filters">
      <div class="fgrp"><div class="flbl">View</div>
        <select id="taskViewSel" class="fsel">
          <option value="today">Today</option>
          <option value="upcoming">Upcoming</option>
          <option value="all">All</option>
        </select>
      </div>
      <span class="hint">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªØ¹Ù…Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ Ø£Ø«Ù†Ø§Ø¡ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© (Push ÙŠØ­ØªØ§Ø¬ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¥Ø¶Ø§ÙÙŠ).</span>
    </div>

    <div class="tcard">
      <div class="table-scroll">
        <table style="min-width:780px">
          <thead>
            <tr>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
              <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
              <th class="tcenter">ØªÙ…</th>
              <th class="tcenter"></th>
            </tr>
          </thead>
          <tbody id="tasksBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- REPORTS & FORMS (template page) -->
  <div id="p-reports" class="page">
    <div class="ph">
      <div class="ptitle">Reports & Forms</div>
      <button class="btn secondary" id="dummyBtn">Template</button>
    </div>

    <div class="tcard" style="padding:18px">
      <div style="display:grid;grid-template-columns:1.2fr .8fr;gap:16px;align-items:start">
        <div style="background:linear-gradient(180deg,#fff,#fff7ed);border:1px solid var(--g200);border-radius:16px;padding:16px">
          <div style="font-weight:1000;font-size:16px;margin-bottom:8px">Ù‚Ø§Ù„Ø¨ ØµÙØ­Ø© (Cards + Table)</div>
          <div class="small">Ù‡Ù†Ø§ Ù‡Ù†Ø±ÙƒÙ‘Ø¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ÙÙˆØ±Ù…Ø² Ù„Ø§Ø­Ù‚Ù‹Ø§. Ø§Ù„ØªØµÙ…ÙŠÙ… Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„ÙƒØ±ÙˆØª (Card-based) ÙˆÙ…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„.</div>
          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <span class="tag">Card UI</span>
            <span class="tag">Table Summary</span>
            <span class="tag">RTL</span>
          </div>
        </div>

        <div style="background:#fff;border:1px solid var(--g200);border-radius:16px;padding:16px">
          <div style="font-weight:1000;margin-bottom:10px">Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</div>
          <button class="btn secondary" style="width:100%;margin-bottom:8px">Create Report</button>
          <button class="btn secondary" style="width:100%;margin-bottom:8px">Upload Form</button>
          <button class="btn secondary" style="width:100%">Export</button>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Modals -->
<div id="modal" class="modal">
  <div class="mcard2">
    <div class="mtitle" id="modalTitle"></div>
    <div id="modalBody"></div>
    <div class="mactions" id="modalActions"></div>
  </div>
</div>

<script>
  /**********************
   * Supabase config
   **********************/
  const SUPABASE_URL = "https://milqizzksncspauhxxhh.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1pbHFpenprc25jc3BhdWh4eGhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NDA0MzgsImV4cCI6MjA4NzQxNjQzOH0.Bff2n6VC4qlMvBZS9Ys2vU7FmpLL3s7220Cdz9tu6aI";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // Role-based access control (admin/viewer)
  let IS_ADMIN = false;

  async function fetchMyRole(){
    const { data: { user } } = await sb.auth.getUser();
    if(!user){ IS_ADMIN = false; applyRoleUI(); return; }
    const { data, error } = await sb
      .from('user_profiles')
      .select('role')
      .eq('user_id', user.id)
      .maybeSingle();
    IS_ADMIN = !!(data && data.role === 'admin');
    applyRoleUI();
  }

  function applyRoleUI(){
    document.querySelectorAll('.admin-only').forEach(el=>{
      el.style.display = IS_ADMIN ? '' : 'none';
    });
    // Disable inline edits for non-admin (best-effort)
    document.documentElement.classList.toggle('is-admin', IS_ADMIN);
  }

  function requireAdmin(){
    if(IS_ADMIN) return true;
    toast('Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·.');
    return false;
  }

  /**********************
   * App state (NOT persisted)
   **********************/
  const state = {
    activeYear: null,
    years: [],
    inventory: [],
    schools: [],
    selectedSchool: null,
    selectedYear: null,
    selectedMonth: null
  };

  /**********************
   * Helpers
   **********************/
  const $ = (id)=>document.getElementById(id);
  const esc = (s)=> String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  const todayISO = ()=> new Date().toISOString().slice(0,10);
  const nowHM = ()=> new Date().toTimeString().slice(0,5);
  const show = (el, on)=> el.style.display = on ? "" : "none";

  function openModal(title, bodyHTML, actions){
    $("modalTitle").innerText = title;
    $("modalBody").innerHTML = bodyHTML;
    const act = $("modalActions");
    act.innerHTML = "";
    for(const a of actions){
      const b = document.createElement("button");
      b.className = a.className || "btn secondary";
      b.textContent = a.label;
      b.onclick = a.onClick;
      act.appendChild(b);
    }
    $("modal").classList.add("on");
  }
  function closeModal(){ $("modal").classList.remove("on"); }

  function nav(pageId){
    // reset page-specific state on every navigation
    document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
    $(pageId).classList.add("active");
    // back button
    $("backBtn").classList.toggle("show", pageId !== "p-home");
    // clear school details on leaving schools page
    if(pageId !== "p-schools"){
      state.selectedSchool = null;
      show($("schoolDetails"), false);
    }
  }

  function fillYearSelect(sel, includePlaceholder=true){
    sel.innerHTML = "";
    if(includePlaceholder){
      const o = document.createElement("option");
      o.value = "";
      o.textContent = "-- Ø§Ø®ØªØ± --";
      sel.appendChild(o);
    }
    for(const y of state.years){
      const o = document.createElement("option");
      o.value = String(y.year);
      o.textContent = String(y.year);
      sel.appendChild(o);
    }
  }
  function fillMonthSelect(sel, includePlaceholder=true){
    sel.innerHTML = "";
    if(includePlaceholder){
      const o = document.createElement("option");
      o.value = "";
      o.textContent = "-- Ø§Ø®ØªØ± --";
      sel.appendChild(o);
    }
    for(let m=1;m<=12;m++){
      const o = document.createElement("option");
      o.value = String(m);
      o.textContent = String(m);
      sel.appendChild(o);
    }
  }

  function isArchived(year){
    const y = state.years.find(x=>x.year === year);
    return y && y.status === "archived";
  }
  function refreshYearTags(){
    const y = state.selectedYear ?? state.activeYear;
    const archived = isArchived(y);
    const tag = $("yearTag");
    tag.className = "tag" + (archived ? " arch" : "");
    tag.textContent = archived ? `Archived Year: ${y}` : `Active Year: ${y}`;

    const tag2 = $("extraYearTag");
    tag2.className = "tag" + (archived ? " arch" : "");
    tag2.textContent = archived ? `Archived Year: ${y}` : `Active Year: ${y}`;

    $("activeYearLbl").textContent = `Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù†Ø´Ø·Ø©: ${state.activeYear} â€” Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø£Ø±Ø´ÙŠÙ (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)`;
  }

  /**********************
   * Auth
   **********************/
  async function doLogin(){
    const email = $("email").value.trim();
    const password = $("password").value;
    $("loginErr").style.display="none";
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if(error){
      $("loginErr").textContent = error.message;
      $("loginErr").style.display="";
      return;
    }
    await boot();
  }

  async function doLogout(){
    await sb.auth.signOut();
    location.reload();
  }

  /**********************
   * Data fetch
   **********************/
  async function loadSettingsYears(){
    // settings: active year
    const { data: settings, error: sErr } = await sb.from("app_settings").select("*").eq("id",1).maybeSingle();
    if(sErr) throw sErr;

    const { data: years, error: yErr } = await sb.from("app_years").select("*").order("year",{ascending:false});
    if(yErr) throw yErr;

    state.activeYear = settings?.active_year ?? new Date().getFullYear();
    state.years = (years?.length ? years : [{ year: state.activeYear, status:"active" }]);

    // ensure active year exists in list
    if(!state.years.some(y=>y.year===state.activeYear)){
      state.years.unshift({ year: state.activeYear, status:"active" });
    }
  }

  async function loadInventory(){
    const { data, error } = await sb.from("inventory_items").select("*").order("created_at",{ascending:false});
    if(error) throw error;
    state.inventory = data ?? [];
  }

  async function loadSchools(){
    const { data, error } = await sb.from("schools").select("*").order("created_at",{ascending:false});
    if(error) throw error;
    state.schools = data ?? [];
  }

  /**********************
   * Inventory UI
   **********************/
  function renderInventory(){
    const body = $("invBody");
    body.innerHTML = "";
    for(const r of state.inventory){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="tdp mono">${esc(r.code)}</td>
        <td class="tdp">${esc(r.category)}</td>
        <td class="tdp"><b>${esc(r.name)}</b></td>
        <td class="tdp tcenter">${qtyCounterHTML(r.total_qty, true)}</td>
        <td class="tdp">${esc(r.notes||"")}</td>
        <td class="tdp tcenter">
          <div class="act"><button class="actbtn" data-act="inv" data-id="${esc(r.id)}">â‹®</button></div>
        </td>
      `;
      body.appendChild(tr);
    }
    bindActionButtons();
  }

  function qtyCounterHTML(val, locked){
    const cls = locked ? "qctr disabled" : "qctr";
    return `
      <div class="${cls}">
        <button ${locked?"disabled":""} data-q="-1">âˆ’</button>
        <span>${Number(val||0)}</span>
        <button ${locked?"disabled":""} data-q="1">+</button>
      </div>`;
  }

  async function addOrEditInventory(item){
    const isEdit = !!item;
    openModal(isEdit?"ØªØ¹Ø¯ÙŠÙ„ ØµÙ†Ù":"Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù", `
      <div class="mrow">
        <div style="flex:1">
          <div class="small">ÙƒÙˆØ¯</div>
          <input id="mInvCode" class="minput mono" placeholder="Ù…Ø«Ø§Ù„: A-001" value="${esc(item?.code||"")}" />
        </div>
        <div style="flex:1">
          <div class="small">Ø§Ù„ØµÙ†Ù</div>
          <input id="mInvCat" class="minput" placeholder="Components / Machines / Kits / Materials" value="${esc(item?.category||"")}" />
        </div>
      </div>
      <div style="margin-top:10px">
        <div class="small">Ø§Ù„Ø§Ø³Ù…</div>
        <input id="mInvName" class="minput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" value="${esc(item?.name||"")}" />
      </div>
      <div style="margin-top:10px">
        <div class="small">Ø§Ù„Ø¹Ø¯Ø¯</div>
        <input id="mInvQty" class="minput" type="number" min="0" value="${Number(item?.total_qty||0)}" />
      </div>
      <div style="margin-top:10px">
        <div class="small">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
        <textarea id="mInvNotes" class="mtextarea" placeholder="...">${esc(item?.notes||"")}</textarea>
      </div>
    `, [
      { label:"Ø¥Ù„ØºØ§Ø¡", className:"btn secondary", onClick: closeModal },
      { label:"Ø­ÙØ¸", className:"btn", onClick: async ()=>{
          const payload = {
            code: $("mInvCode").value.trim(),
            category: $("mInvCat").value.trim(),
            name: $("mInvName").value.trim(),
            total_qty: Number($("mInvQty").value||0),
            notes: $("mInvNotes").value.trim()
          };
          if(!payload.code || !payload.name){
            alert("Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ø§Ø³Ù…");
            return;
          }
          try{
            if(isEdit){
              const { error } = await sb.from("inventory_items").update(payload).eq("id", item.id);
              if(error) throw error;
            }else{
              const { error } = await sb.from("inventory_items").insert(payload);
              if(error) throw error;
            }
            closeModal();
            await loadInventory();
            renderInventory();
          }catch(e){ alert(e.message); }
      }}
    ]);
  }

  /**********************
   * Schools UI
   **********************/
  function renderSchools(){
    const body = $("schoolsBody");
    body.innerHTML = "";
    for(const s of state.schools){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="tdp mono">${esc(s.code)}</td>
        <td class="tdp"><b>${esc(s.name)}</b></td>
        <td class="tdp">${esc(s.notes||"")}</td>
        <td class="tdp tcenter">
          <button class="btn secondary" data-open-school="${esc(s.id)}">ÙØªØ­</button>
        </td>
      `;
      body.appendChild(tr);
    }
    document.querySelectorAll("[data-open-school]").forEach(b=>{
      b.onclick = ()=> openSchool(b.getAttribute("data-open-school"));
    });
  }

  async function addOrEditSchool(school){
    const isEdit = !!school;
    openModal(isEdit?"ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¯Ø±Ø³Ø©":"Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø±Ø³Ø©", `
      <div class="mrow">
        <div style="flex:1">
          <div class="small">ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
          <input id="mSchCode" class="minput mono" placeholder="Ù…Ø«Ø§Ù„: SCH-01" value="${esc(school?.code||"")}" />
        </div>
        <div style="flex:2">
          <div class="small">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
          <input id="mSchName" class="minput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" value="${esc(school?.name||"")}" />
        </div>
      </div>
      <div style="margin-top:10px">
        <div class="small">Ù…Ù„Ø§Ø­Ø¸Ø§Øª / Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
        <textarea id="mSchNotes" class="mtextarea" placeholder="...">${esc(school?.notes||"")}</textarea>
      </div>
      <div class="small" style="margin-top:10px;color:var(--g600)">
        âœ… Ù…ÙŠØ²Ø©: Ø¹Ù†Ø¯ ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ø¶ØºØ· Enter Ø³ÙŠØªÙ… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯Ø±Ø³Ø© Ø¨Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©).
      </div>
    `, [
      { label:"Ø¥Ù„ØºØ§Ø¡", className:"btn secondary", onClick: closeModal },
      { label:"Ø­ÙØ¸", className:"btn", onClick: async ()=>{
          try{
            const payload = {
              code: $("mSchCode").value.trim(),
              name: $("mSchName").value.trim(),
              notes: $("mSchNotes").value.trim()
            };
            if(!payload.code || !payload.name){ alert("Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ø§Ø³Ù…"); return; }

            if(isEdit){
              const { error } = await sb.from("schools").update(payload).eq("id", school.id);
              if(error) throw error;
            }else{
              const { error } = await sb.from("schools").insert(payload);
              if(error) throw error;
            }
            closeModal();
            await loadSchools();
            renderSchools();
            await refreshSchoolDropdowns();
          }catch(e){ alert(e.message); }
      }}
    ]);

    // Autofill by code
    const codeInput = $("mSchCode");
    codeInput.addEventListener("keydown", async (ev)=>{
      if(ev.key !== "Enter") return;
      ev.preventDefault();
      const code = codeInput.value.trim();
      if(!code) return;
      const { data, error } = await sb.from("schools").select("*").eq("code", code).maybeSingle();
      if(error){ alert(error.message); return; }
      if(data){
        $("mSchName").value = data.name || "";
        $("mSchNotes").value = data.notes || "";
      }
    });
  }

  async function openSchool(id){
    const school = state.schools.find(s=>s.id===id);
    state.selectedSchool = school;
    $("schoolDetailsTitle").innerText = `ØªÙˆØ²ÙŠØ¹Ø§Øª: ${school.name} (${school.code})`;

    // enforce default year/month if empty
    if(!state.selectedYear) state.selectedYear = state.activeYear;
    $("schoolYearSel").value = String(state.selectedYear);
    $("schoolMonthSel").value = state.selectedMonth ? String(state.selectedMonth) : "";

    refreshYearTags();
    show($("schoolDetails"), true);

    await renderDistributions();
    updateEditability();
  }

  function updateEditability(){
    const y = Number($("schoolYearSel").value || state.activeYear);
    state.selectedYear = y;
    state.selectedMonth = $("schoolMonthSel").value ? Number($("schoolMonthSel").value) : null;

    const archived = isArchived(y) || (y !== state.activeYear);
    const tag = $("yearTag");
    tag.className = "tag" + (archived ? " arch" : "");
    tag.textContent = archived ? `Archived Year: ${y}` : `Active Year: ${y}`;

    // Disallow adding/editing if archived
    $("addDistBtn").disabled = archived || !state.selectedSchool;
    $("addExtraBtn").disabled = archived;
  }

  async function renderDistributions(){
    if(!state.selectedSchool) return;
    const schoolId = state.selectedSchool.id;
    const year = Number($("schoolYearSel").value || state.activeYear);
    const monthVal = $("schoolMonthSel").value ? Number($("schoolMonthSel").value) : null;

    let q = sb.from("school_distributions")
      .select("id,created_at,year,month,qty_sent,notes,source, inventory_items(id,code,category,name)")
      .eq("school_id", schoolId)
      .eq("year", year)
      .order("created_at",{ascending:false});

    if(monthVal) q = q.eq("month", monthVal);

    const { data, error } = await q;
    if(error){ alert(error.message); return; }

    const body = $("distBody");
    body.innerHTML = "";
    for(const r of (data||[])){
      const inv = r.inventory_items || {};
      const dateStr = (r.created_at||"").slice(0,10);
      body.insertAdjacentHTML("beforeend", `
        <tr>
          <td class="tdp">${esc(dateStr)} <span class="small">${r.source==="extra"?"(extra)":""}</span></td>
          <td class="tdp mono">${esc(inv.code||"")}</td>
          <td class="tdp">${esc(inv.name||"")}</td>
          <td class="tdp tcenter">${qtyCounterHTML(r.qty_sent, true)}</td>
          <td class="tdp">${esc(r.notes||"")}</td>
          <td class="tdp tcenter"><div class="act"><button class="actbtn" data-act="dist" data-id="${esc(r.id)}">â‹®</button></div></td>
        </tr>
      `);
    }
    bindActionButtons();
  }

  function invOptionsHTML(selectedId){
    return state.inventory.map(i=>`<option value="${esc(i.id)}" ${i.id===selectedId?"selected":""}>${esc(i.code)} â€” ${esc(i.name)}</option>`).join("");
  }

  async function addOrEditDistribution(dist, source="normal"){
    const y = Number($("schoolYearSel").value || state.activeYear);
    const m = $("schoolMonthSel").value ? Number($("schoolMonthSel").value) : null;

    if(!state.selectedSchool){ alert("Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³Ø©"); return; }
    if(!y){ alert("Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø©"); return; }
    if(!m){ alert("Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±"); return; } // distributions must be tied to month for tracking

    const archived = isArchived(y) || (y !== state.activeYear);
    if(archived){ alert("Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø© Ø£Ø±Ø´ÙŠÙ (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)"); return; }

    const isEdit = !!dist;
    openModal(isEdit?"ØªØ¹Ø¯ÙŠÙ„ ØªÙˆØ²ÙŠØ¹":"Ø¥Ø¶Ø§ÙØ© ØªÙˆØ²ÙŠØ¹", `
      <div class="mrow">
        <div style="flex:2">
          <div class="small">Ø§Ù„ØµÙ†Ù (Ù…Ù† Ø§Ù„Ø¥Ù†ÙÙ†ØªÙˆØ±ÙŠ)</div>
          <select id="mDistInv" class="mselect">
            <option value="">-- Ø§Ø®ØªØ± --</option>
            ${invOptionsHTML(dist?.inventory_id)}
          </select>
        </div>
        <div style="flex:1">
          <div class="small">Ø§Ù„Ù…Ø±Ø³Ù„Ø©</div>
          <input id="mDistQty" class="minput" type="number" min="0" value="${Number(dist?.qty_sent||0)}" />
        </div>
      </div>
      <div style="margin-top:10px">
        <div class="small">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
        <textarea id="mDistNotes" class="mtextarea" placeholder="...">${esc(dist?.notes||"")}</textarea>
      </div>
      <div class="small" style="margin-top:10px">Year: <b>${y}</b> â€” Month: <b>${m}</b></div>
    `, [
      { label:"Ø¥Ù„ØºØ§Ø¡", className:"btn secondary", onClick: closeModal },
      ...(isEdit ? [{ label:"Ø­Ø°Ù", className:"btn danger", onClick: async ()=>{
          if(!confirm("Ø­Ø°Ù Ø§Ù„ØµÙØŸ")) return;
          try{
            const { error } = await sb.from("school_distributions").delete().eq("id", dist.id);
            if(error) throw error;
            closeModal();
            await renderDistributions();
            await renderExtraRequests();
          }catch(e){ alert(e.message); }
      }}] : []),
      { label:"Ø­ÙØ¸", className:"btn", onClick: async ()=>{
          const inventory_id = $("mDistInv").value;
          const qty_sent = Number($("mDistQty").value||0);
          const notes = $("mDistNotes").value.trim();
          if(!inventory_id){ alert("Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù"); return; }

          try{
            if(isEdit){
              const { error } = await sb.from("school_distributions").update({ inventory_id, qty_sent, notes }).eq("id", dist.id);
              if(error) throw error;
            }else{
              const payload = {
                school_id: state.selectedSchool.id,
                inventory_id,
                year: y,
                month: m,
                qty_sent,
                notes,
                source
              };
              const { error } = await sb.from("school_distributions").insert(payload);
              if(error) throw error;
            }
            closeModal();
            await renderDistributions();
            await renderExtraRequests();
          }catch(e){ alert(e.message); }
      }}
    ]);
  }

  /**********************
   * Extra Requests UI (source='extra')
   **********************/
  async function renderExtraRequests(){
    const year = Number($("extraYearSel").value || state.activeYear);
    const monthVal = $("extraMonthSel").value ? Number($("extraMonthSel").value) : null;

    let q = sb.from("school_distributions")
      .select("id,created_at,year,month,qty_sent,notes,source, school_id, schools(id,code,name), inventory_items(id,code,name)")
      .eq("year", year)
      .eq("source","extra")
      .order("created_at",{ascending:false});

    if(monthVal) q = q.eq("month", monthVal);

    const { data, error } = await q;
    if(error){ alert(error.message); return; }

    const body = $("extraBody");
    body.innerHTML = "";
    for(const r of (data||[])){
      const sch = r.schools || {};
      const inv = r.inventory_items || {};
      body.insertAdjacentHTML("beforeend", `
        <tr>
          <td class="tdp">${esc((r.created_at||"").slice(0,10))}</td>
          <td class="tdp"><b>${esc(sch.name||"")}</b> <span class="small mono">${esc(sch.code||"")}</span></td>
          <td class="tdp mono">${esc(inv.code||"")}</td>
          <td class="tdp">${esc(inv.name||"")}</td>
          <td class="tdp tcenter">${qtyCounterHTML(r.qty_sent, true)}</td>
          <td class="tdp">${esc(r.notes||"")}</td>
          <td class="tdp tcenter"><div class="act"><button class="actbtn" data-act="extra" data-id="${esc(r.id)}">â‹®</button></div></td>
        </tr>
      `);
    }
    bindActionButtons();
  }

  async function addExtraRequest(){
    const y = Number($("extraYearSel").value || state.activeYear);
    const m = $("extraMonthSel").value ? Number($("extraMonthSel").value) : null;
    if(!m){ alert("Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±"); return; }
    const archived = isArchived(y) || (y !== state.activeYear);
    if(archived){ alert("Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø© Ø£Ø±Ø´ÙŠÙ (Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)"); return; }

    const schoolOpts = state.schools.map(s=>`<option value="${esc(s.id)}">${esc(s.code)} â€” ${esc(s.name)}</option>`).join("");
    openModal("Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¥Ø¶Ø§ÙÙŠ", `
      <div class="mrow">
        <div style="flex:2">
          <div class="small">Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
          <select id="mExtraSchool" class="mselect">
            <option value="">-- Ø§Ø®ØªØ± --</option>
            ${schoolOpts}
          </select>
        </div>
        <div style="flex:2">
          <div class="small">Ø§Ù„ØµÙ†Ù (Ù…Ù† Ø§Ù„Ø¥Ù†ÙÙ†ØªÙˆØ±ÙŠ)</div>
          <select id="mExtraInv" class="mselect">
            <option value="">-- Ø§Ø®ØªØ± --</option>
            ${invOptionsHTML("")}
          </select>
        </div>
      </div>
      <div class="mrow" style="margin-top:10px">
        <div style="flex:1">
          <div class="small">Ø§Ù„Ù…Ø±Ø³Ù„Ø©</div>
          <input id="mExtraQty" class="minput" type="number" min="0" value="1" />
        </div>
        <div style="flex:2">
          <div class="small">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
          <input id="mExtraNotes" class="minput" placeholder="..." />
        </div>
      </div>
      <div class="small" style="margin-top:10px">Year: <b>${y}</b> â€” Month: <b>${m}</b></div>
    `, [
      { label:"Ø¥Ù„ØºØ§Ø¡", className:"btn secondary", onClick: closeModal },
      { label:"Ø­ÙØ¸", className:"btn", onClick: async ()=>{
          const school_id = $("mExtraSchool").value;
          const inventory_id = $("mExtraInv").value;
          const qty_sent = Number($("mExtraQty").value||0);
          const notes = $("mExtraNotes").value.trim();
          if(!school_id || !inventory_id){ alert("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙˆØ§Ù„ØµÙ†Ù"); return; }
          try{
            const { error } = await sb.from("school_distributions").insert({ school_id, inventory_id, year:y, month:m, qty_sent, notes, source:"extra" });
            if(error) throw error;
            closeModal();
            await renderExtraRequests();
          }catch(e){ alert(e.message); }
      }}
    ]);
  }

  /**********************
   * Audit UI
   **********************/
  async function refreshSchoolDropdowns(){
    // audit school select
    const sel = $("auditSchoolSel");
    sel.innerHTML = `<option value="">-- Ø§Ø®ØªØ± --</option>` + state.schools.map(s=>`<option value="${esc(s.id)}">${esc(s.code)} â€” ${esc(s.name)}</option>`).join("");
  }

  async function renderAudit(){
    const schoolId = $("auditSchoolSel").value || null;
    const yearVal = $("auditYearSel").value ? Number($("auditYearSel").value) : null;
    const monthVal = $("auditMonthSel").value ? Number($("auditMonthSel").value) : null;

    const body = $("auditBody");
    body.innerHTML = "";
    if(!yearVal){
      body.innerHTML = `<tr><td class="tdp" colspan="5"><span class="hint">Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø© Ø£ÙˆÙ„Ø§Ù‹.</span></td></tr>`;
      return;
    }

    // build query on view
    let q = sb.from("v_audit").select("*").eq("year", yearVal).order("category",{ascending:true}).order("code",{ascending:true});
    if(monthVal) q = q.eq("month", monthVal);
    if(schoolId) q = q.eq("school_id", schoolId);

    const { data, error } = await q;
    if(error){ alert(error.message); return; }
    if(!(data||[]).length){
      body.innerHTML = `<tr><td class="tdp" colspan="5"><span class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</span></td></tr>`;
      return;
    }
    for(const r of data){
      const dmg = Math.max(0, (r.qty_sent||0) - (r.qty_actual||0));
      body.insertAdjacentHTML("beforeend", `
        <tr>
          <td class="tdp mono">${esc(r.code)}</td>
          <td class="tdp">${esc(r.name)}</td>
          <td class="tdp tcenter"><b>${Number(r.qty_sent||0)}</b></td>
          <td class="tdp tcenter"><b>${Number(r.qty_actual||0)}</b></td>
          <td class="tdp tcenter"><b>${Number(dmg)}</b></td>
        </tr>
      `);
    }
  }

  /**********************
   * Tasks (Daily Tasks)
   **********************/
  async function renderTasks(){
    const view = $("taskViewSel").value;
    const body = $("tasksBody");
    body.innerHTML = "";

    let q = sb.from("tasks").select("*").order("due_date",{ascending:true}).order("created_at",{ascending:false});
    if(view==="today"){
      q = q.eq("due_date", todayISO());
    }else if(view==="upcoming"){
      q = q.gte("due_date", todayISO()).eq("done", false);
    }
    const { data, error } = await q;
    if(error){ alert(error.message); return; }
    if(!(data||[]).length){
      body.innerHTML = `<tr><td class="tdp" colspan="5"><span class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù….</span></td></tr>`;
      return;
    }
    for(const t of data){
      body.insertAdjacentHTML("beforeend", `
        <tr>
          <td class="tdp">${esc(t.due_date)} <span class="small">${esc(t.due_time||"")}</span></td>
          <td class="tdp"><b>${esc(t.title)}</b></td>
          <td class="tdp">${esc(t.details||"")}</td>
          <td class="tdp tcenter"><input type="checkbox" data-done="${esc(t.id)}" ${t.done?"checked":""} /></td>
          <td class="tdp tcenter"><div class="act"><button class="actbtn" data-act="task" data-id="${esc(t.id)}">â‹®</button></div></td>
        </tr>
      `);
    }
    document.querySelectorAll("[data-done]").forEach(ch=>{
      ch.onchange = async ()=>{
        const id = ch.getAttribute("data-done");
        await sb.from("tasks").update({ done: ch.checked }).eq("id", id);
      };
    });
    bindActionButtons();
  }

  async function addOrEditTask(task){
    const isEdit = !!task;
    openModal(isEdit?"ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‡Ù…Ø©":"Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©", `
      <div class="mrow">
        <div style="flex:2">
          <div class="small">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div>
          <input id="mTaskTitle" class="minput" value="${esc(task?.title||"")}" placeholder="..." />
        </div>
        <div style="flex:1">
          <div class="small">Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
          <input id="mTaskDate" class="minput" type="date" value="${esc(task?.due_date||todayISO())}" />
        </div>
        <div style="flex:1">
          <div class="small">Ø§Ù„ÙˆÙ‚Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
          <input id="mTaskTime" class="minput" type="time" value="${esc(task?.due_time||"")}" />
        </div>
      </div>
      <div style="margin-top:10px">
        <div class="small">ØªÙØ§ØµÙŠÙ„</div>
        <textarea id="mTaskDetails" class="mtextarea" placeholder="...">${esc(task?.details||"")}</textarea>
      </div>
      <div class="small" style="margin-top:10px;color:var(--g600)">
        ğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø£Ùˆ ØªØ±ÙƒÙ‡ Ù…ÙØªÙˆØ­) ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ….
      </div>
    `, [
      { label:"Ø¥Ù„ØºØ§Ø¡", className:"btn secondary", onClick: closeModal },
      ...(isEdit ? [{ label:"Ø­Ø°Ù", className:"btn danger", onClick: async ()=>{
          if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ")) return;
          await sb.from("tasks").delete().eq("id", task.id);
          closeModal();
          await renderTasks();
      }}] : []),
      { label:"Ø­ÙØ¸", className:"btn", onClick: async ()=>{
          const payload = {
            title: $("mTaskTitle").value.trim(),
            due_date: $("mTaskDate").value,
            due_time: $("mTaskTime").value || null,
            details: $("mTaskDetails").value.trim()
          };
          if(!payload.title){ alert("Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©"); return; }
          try{
            if(isEdit){
              const { error } = await sb.from("tasks").update(payload).eq("id", task.id);
              if(error) throw error;
            }else{
              const { error } = await sb.from("tasks").insert({ ...payload, done:false });
              if(error) throw error;
            }
            closeModal();
            await renderTasks();
          }catch(e){ alert(e.message); }
      }}
    ]);
  }

  async function taskNotifierTick(){
    if(!("Notification" in window)) return;
    if(Notification.permission !== "granted") return;

    const nowDate = todayISO();
    const nowTime = nowHM();

    const { data, error } = await sb.from("tasks")
      .select("*")
      .eq("done", false)
      .eq("due_date", nowDate)
      .or(`notified_at.is.null,notified_at.lt.${nowDate}T00:00:00Z`);

    if(error) return;

    for(const t of (data||[])){
      // time check: if due_time exists, only notify after it
      if(t.due_time && nowTime < t.due_time) continue;

      new Notification("Pyramakerz â€” Task", { body: t.title });
      await sb.from("tasks").update({ notified_at: new Date().toISOString() }).eq("id", t.id);
    }
  }

  /**********************
   * Row actions (modal outside table)
   **********************/
  function bindActionButtons(){
    document.querySelectorAll("[data-act]").forEach(btn=>{
      btn.onclick = async ()=>{
        const kind = btn.getAttribute("data-act");
        const id = btn.getAttribute("data-id");

        if(kind==="inv"){
          const item = state.inventory.find(x=>x.id===id);
          openModal("Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØµÙ†Ù", `<div class="hint">Ø§Ø®ØªØ± Ø¥Ø¬Ø±Ø§Ø¡:</div>`, [
            { label:"Ø¥Ù„ØºØ§Ø¡", className:"btn secondary", onClick: closeModal },
            { label:"ØªØ¹Ø¯ÙŠÙ„", className:"btn", onClick: ()=>{ closeModal(); addOrEditInventory(item); } },
            { label:"Ø­Ø°Ù", className:"btn danger", onClick: async ()=>{
                if(!confirm("Ø­Ø°Ù Ø§Ù„ØµÙ†ÙØŸ")) return;
                const { error } = await sb.from("inventory_items").delete().eq("id", id);
                if(error){ alert(error.message); return; }
                closeModal();
                await loadInventory(); renderInventory();
            }}
          ]);
          return;
        }

        if(kind==="dist"){
          // fetch dist row for edit
          const { data, error } = await sb.from("school_distributions").select("*").eq("id", id).maybeSingle();
          if(error){ alert(error.message); return; }
          openModal("Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªÙˆØ²ÙŠØ¹", `<div class="hint">Ø§Ø®ØªØ± Ø¥Ø¬Ø±Ø§Ø¡:</div>`, [
            { label:"Ø¥Ù„ØºØ§Ø¡", className:"btn secondary", onClick: closeModal },
            { label:"ØªØ¹Ø¯ÙŠÙ„", className:"btn", onClick: ()=>{ closeModal(); addOrEditDistribution(data, data.source||"normal"); } },
            { label:"Ø­Ø°Ù", className:"btn danger", onClick: async ()=>{
                if(!confirm("Ø­Ø°Ù Ø§Ù„ØµÙØŸ")) return;
                const { error: delErr } = await sb.from("school_distributions").delete().eq("id", id);
                if(delErr){ alert(delErr.message); return; }
                closeModal();
                await renderDistributions();
            }}
          ]);
          return;
        }

        if(kind==="extra"){
          const { data, error } = await sb.from("school_distributions").select("*").eq("id", id).maybeSingle();
          if(error){ alert(error.message); return; }
          openModal("Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø·Ù„Ø¨", `<div class="hint">Ø§Ø®ØªØ± Ø¥Ø¬Ø±Ø§Ø¡:</div>`, [
            { label:"Ø¥Ù„ØºØ§Ø¡", className:"btn secondary", onClick: closeModal },
            { label:"ØªØ¹Ø¯ÙŠÙ„", className:"btn", onClick: ()=>{ closeModal();
                // open edit in extra page
                state.selectedSchool = state.schools.find(s=>s.id===data.school_id) || null;
                // temporarily allow edit via same dialog
                addOrEditDistribution(data, "extra");
            }},
            { label:"Ø­Ø°Ù", className:"btn danger", onClick: async ()=>{
                if(!confirm("Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;
                const { error: delErr } = await sb.from("school_distributions").delete().eq("id", id);
                if(delErr){ alert(delErr.message); return; }
                closeModal();
                await renderExtraRequests();
            }}
          ]);
          return;
        }

        if(kind==="task"){
          const { data, error } = await sb.from("tasks").select("*").eq("id", id).maybeSingle();
          if(error){ alert(error.message); return; }
          openModal("Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø©", `<div class="hint">Ø§Ø®ØªØ± Ø¥Ø¬Ø±Ø§Ø¡:</div>`, [
            { label:"Ø¥Ù„ØºØ§Ø¡", className:"btn secondary", onClick: closeModal },
            { label:"ØªØ¹Ø¯ÙŠÙ„", className:"btn", onClick: ()=>{ closeModal(); addOrEditTask(data); } },
            { label:"Ø­Ø°Ù", className:"btn danger", onClick: async ()=>{
                if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ")) return;
                await sb.from("tasks").delete().eq("id", id);
                closeModal();
                await renderTasks();
            }}
          ]);
          return;
        }
      };
    });
  }

  /**********************
   * Boot
   **********************/
  async function boot(){
    // Check auth session
    const { data: { session } } = await sb.auth.getSession();
    if(!session){
      $("login").style.display="";
      $("app").style.display="none";
      return;
    }

    $("login").style.display="none";
    $("app").style.display="";

    // Reset state on every entry (no "continue where left off")
    state.selectedSchool = null;
    state.selectedYear = null;
    state.selectedMonth = null;
    nav("p-home");

    await loadSettingsYears();
    await loadInventory();
    await loadSchools();
    await refreshSchoolDropdowns();

    // year/month selects
    fillYearSelect($("schoolYearSel"), false);
    fillMonthSelect($("schoolMonthSel"), true);
    fillYearSelect($("extraYearSel"), false);
    fillMonthSelect($("extraMonthSel"), true);
    fillYearSelect($("auditYearSel"), true);
    fillMonthSelect($("auditMonthSel"), true);

    // set defaults: active year selected automatically
    $("schoolYearSel").value = String(state.activeYear);
    $("extraYearSel").value = String(state.activeYear);
    $("auditYearSel").value = String(state.activeYear);

    state.selectedYear = state.activeYear;

    refreshYearTags();

    // render
    renderInventory();
    renderSchools();
    await renderExtraRequests();
    await renderAudit();
    await renderTasks();

    updateEditability();

    // notifications permission (optional)
    if("Notification" in window && Notification.permission === "default"){
      // do not block; user can allow later
      setTimeout(()=>{ Notification.requestPermission().catch(()=>{}); }, 1200);
    }
    // notifier tick each 60s while open
    setInterval(taskNotifierTick, 60000);
    taskNotifierTick();
  }

  /**********************
   * Wire UI events
   **********************/
  $("loginBtn").onclick = doLogin;
  $("logoutBtn").onclick = doLogout;

  $("homeBtn").onclick = ()=> nav("p-home");
  $("backBtn").onclick = ()=> nav("p-home");
  document.querySelectorAll("[data-nav]").forEach(card=>{
    card.onclick = async ()=>{
      const page = card.getAttribute("data-nav");
      nav(page);
      if(page==="p-inventory"){ await loadInventory(); renderInventory(); }
      if(page==="p-schools"){ await loadSchools(); renderSchools(); }
      if(page==="p-extra"){ await renderExtraRequests(); }
      if(page==="p-audit"){ await renderAudit(); }
      if(page==="p-daily"){ await renderTasks(); }
    };
  });

  $("modal").addEventListener("click", (e)=>{ if(e.target.id==="modal") closeModal(); });

  $("addInvBtn").onclick = ()=> addOrEditInventory(null);
  $("addSchoolBtn").onclick = ()=> addOrEditSchool(null);
  $("addDistBtn").onclick = ()=> addOrEditDistribution(null, "normal");
  $("addExtraBtn").onclick = addExtraRequest;
  $("addTaskBtn").onclick = ()=> addOrEditTask(null);

  $("schoolYearSel").onchange = async ()=>{
    state.selectedYear = Number($("schoolYearSel").value || state.activeYear);
    refreshYearTags();
    updateEditability();
    if(state.selectedSchool) await renderDistributions();
  };
  $("schoolMonthSel").onchange = async ()=>{
    state.selectedMonth = $("schoolMonthSel").value ? Number($("schoolMonthSel").value) : null;
    if(state.selectedSchool) await renderDistributions();
  };

  $("extraYearSel").onchange = async ()=>{
    refreshYearTags();
    updateEditability();
    await renderExtraRequests();
  };
  $("extraMonthSel").onchange = renderExtraRequests;

  $("auditSchoolSel").onchange = renderAudit;
  $("auditYearSel").onchange = renderAudit;
  $("auditMonthSel").onchange = renderAudit;

  $("taskViewSel").onchange = renderTasks;

  // initial
  boot();
</script>
</body>
</html>
